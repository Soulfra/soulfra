<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Screenshot OCR - CringeProof</title>
<meta name="description" content="Upload screenshots and extract text with OCR">
<link rel="stylesheet" href="./css/soulfra.css">
<style>
.ocr-container {
    max-width: 800px;
    margin: 2rem auto;
}

.drop-zone {
    border: 4px dashed #000;
    background: #fff;
    padding: 4rem 2rem;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
    margin-bottom: 2rem;
    box-shadow: 8px 8px 0 #bdb2ff;
}

.drop-zone:hover {
    transform: translate(-4px, -4px);
    box-shadow: 12px 12px 0 #bdb2ff;
    background: #ffe5ec;
}

.drop-zone.dragging {
    background: #ffc6ff;
    border-color: #ff006e;
}

.drop-zone-icon {
    font-size: 4rem;
    margin-bottom: 1rem;
}

.drop-zone-text {
    font-size: 1.25rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
}

.drop-zone-hint {
    font-size: 0.875rem;
    opacity: 0.7;
}

.ocr-status {
    background: #fff;
    border: 4px solid #000;
    padding: 1.5rem;
    margin-bottom: 2rem;
    font-weight: 700;
    text-align: center;
    box-shadow: 6px 6px 0 #bdb2ff;
}

.ocr-status.processing {
    border-color: #ff006e;
    animation: pulse 1.5s infinite;
}

.ocr-status.complete {
    border-color: #00C49A;
}

.extracted-text {
    width: 100%;
    min-height: 300px;
    padding: 1.5rem;
    border: 4px solid #000;
    font-family: 'Courier New', monospace;
    font-size: 1rem;
    line-height: 1.6;
    resize: vertical;
    box-shadow: 6px 6px 0 #bdb2ff;
    margin-bottom: 2rem;
}

.action-buttons {
    display: flex;
    gap: 1rem;
    justify-content: center;
}

.btn {
    background: #ff006e;
    color: white;
    border: 4px solid #000;
    padding: 1rem 2rem;
    font-size: 1.125rem;
    font-weight: 900;
    cursor: pointer;
    box-shadow: 6px 6px 0 #000;
    transition: all 0.1s;
    text-transform: uppercase;
}

.btn:hover {
    transform: translate(-2px, -2px);
    box-shadow: 8px 8px 0 #000;
}

.btn:active {
    transform: translate(2px, 2px);
    box-shadow: 2px 2px 0 #000;
}

.btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.btn-secondary {
    background: #000;
    color: #ffe5ec;
}

.preview-image {
    max-width: 100%;
    border: 4px solid #000;
    margin-bottom: 2rem;
    box-shadow: 8px 8px 0 #bdb2ff;
}

.server-config {
    background: #fff;
    border: 4px solid #000;
    padding: 1.5rem;
    margin-bottom: 2rem;
    box-shadow: 6px 6px 0 #bdb2ff;
}

.server-config input {
    width: 100%;
    padding: 0.75rem;
    border: 3px solid #000;
    font-family: 'Courier New', monospace;
    font-size: 1rem;
    margin-top: 0.5rem;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
}
</style>
</head>
<body>
<nav class="soulfra-nav">
    <div class="soulfra-nav-container">
        <a href="https://cringeproof.com/" class="soulfra-logo">
            üö´ CringeProof
        </a>

        <div class="soulfra-links">
            <a href="https://cringeproof.com/ideas/">üí° Ideas</a>
            <a href="https://cringeproof.com/">üé§ Voice Archive</a>
            <a href="https://cringeproof.com/record.html">üéôÔ∏è Record</a>
            <a href="https://cringeproof.com/screenshot.html" class="soulfra-record-btn">üì∏ Screenshot</a>
        </div>
    </div>
</nav>

<div class="container">

<header>
    <h1>üì∏ Screenshot OCR</h1>
    <p class="subtitle">Upload screenshots, extract text with AI</p>
</header>

<div class="ocr-container">

    <div class="server-config">
        <label for="server-url">
            <strong>Local Server URL</strong><br>
            <small>(Your Ollama AI server)</small>
        </label>
        <input
            type="text"
            id="server-url"
            placeholder="https://192.168.1.87:5002"
            value="https://192.168.1.87:5002"
        >
    </div>

    <div class="drop-zone" id="drop-zone">
        <div class="drop-zone-icon">üì∏</div>
        <div class="drop-zone-text">Drop screenshot here or click to upload</div>
        <div class="drop-zone-hint">Supports: PNG, JPG, long screenshots, even PDFs</div>
    </div>

    <input type="file" id="file-input" accept="image/*,.pdf" style="display: none;">

    <img id="preview" class="preview-image" style="display: none;">

    <div class="ocr-status" id="ocr-status">
        Ready to process screenshot
    </div>

    <textarea
        id="extracted-text"
        class="extracted-text"
        placeholder="Extracted text will appear here..."
        readonly
    ></textarea>

    <div class="action-buttons">
        <button class="btn btn-secondary" onclick="clearAll()">Clear</button>
        <button class="btn" id="submit-btn" onclick="submitToOllama()" disabled>Extract Insights with AI</button>
    </div>

</div>

</div>

<footer>
    <div style="margin-bottom: 2rem; padding: 2rem; background: #ff006e; border: 4px solid #000;">
        <p style="font-size: 2rem; font-weight: 900; margin-bottom: 1rem;">üìä How Screenshot OCR Works</p>
        <p style="margin-bottom: 1rem;">
            1. Upload screenshot (Twitter, article, anything with text)<br>
            2. Tesseract.js extracts text in your browser<br>
            3. POST to your local Ollama server<br>
            4. AI extracts structured insights<br>
            5. Idea appears in your archive
        </p>
        <p style="font-size: 0.875rem; opacity: 0.8;">
            <strong>Privacy:</strong> OCR runs 100% in your browser - images never leave your device until you click "Extract Insights"
        </p>
    </div>

    <p><strong>üìä Tech Stack</strong></p>
    <p style="margin-top: 0.5rem; opacity: 0.8;">
        Tesseract.js (OCR) ‚Üí Local Ollama (AI extraction) ‚Üí GitHub Pages (publishing)
    </p>
    <p style="margin-top: 1.5rem;">
        <a href="https://github.com/Soulfra/voice-archive">GitHub</a> |
        <a href="https://cringeproof.com/">Voice Archive</a> |
        <a href="https://cringeproof.com/ideas/">Ideas Hub</a> |
        <a href="https://cringeproof.com/privacy.html">Privacy</a>
    </p>
</footer>

<!-- Tesseract.js for OCR -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

<script>
const dropZone = document.getElementById('drop-zone');
const fileInput = document.getElementById('file-input');
const statusEl = document.getElementById('ocr-status');
const textArea = document.getElementById('extracted-text');
const submitBtn = document.getElementById('submit-btn');
const preview = document.getElementById('preview');

// Click to upload
dropZone.addEventListener('click', () => fileInput.click());

// Drag and drop handlers
dropZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropZone.classList.add('dragging');
});

dropZone.addEventListener('dragleave', () => {
    dropZone.classList.remove('dragging');
});

dropZone.addEventListener('drop', async (e) => {
    e.preventDefault();
    dropZone.classList.remove('dragging');

    const file = e.dataTransfer.files[0];
    if (file && (file.type.startsWith('image/') || file.type === 'application/pdf')) {
        await processImage(file);
    }
});

// File input handler
fileInput.addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (file) {
        await processImage(file);
    }
});

async function processImage(file) {
    // Show preview
    const reader = new FileReader();
    reader.onload = (e) => {
        preview.src = e.target.result;
        preview.style.display = 'block';
    };
    reader.readAsDataURL(file);

    // Check if long screenshot
    const img = await createImageBitmap(file);
    const isLongScreenshot = img.height > 3000;

    statusEl.textContent = isLongScreenshot
        ? 'Detected long screenshot - processing in chunks...'
        : 'Reading screenshot with OCR...';
    statusEl.classList.add('processing');
    textArea.value = '';
    submitBtn.disabled = true;

    try {
        let text;

        if (isLongScreenshot) {
            text = await processLongScreenshot(file, img);
        } else {
            text = await processNormalScreenshot(file);
        }

        textArea.value = text;
        statusEl.textContent = `‚úÖ Extracted ${text.length} characters! Ready to send to AI.`;
        statusEl.classList.remove('processing');
        statusEl.classList.add('complete');
        submitBtn.disabled = false;

    } catch (error) {
        statusEl.textContent = `‚ùå OCR failed: ${error.message}`;
        statusEl.classList.remove('processing');
        console.error('OCR error:', error);
    }
}

async function processNormalScreenshot(file) {
    const worker = await Tesseract.createWorker('eng', 1, {
        logger: (m) => {
            if (m.status === 'recognizing text') {
                statusEl.textContent = `OCR Progress: ${Math.round(m.progress * 100)}%`;
            }
        }
    });

    const { data: { text } } = await worker.recognize(file);
    await worker.terminate();

    return text;
}

async function processLongScreenshot(file, img) {
    const chunkHeight = 1000;
    const chunks = Math.ceil(img.height / chunkHeight);
    let fullText = '';

    const worker = await Tesseract.createWorker('eng');

    for (let i = 0; i < chunks; i++) {
        statusEl.textContent = `Processing chunk ${i + 1}/${chunks}...`;

        // Extract chunk from image
        const canvas = document.createElement('canvas');
        canvas.width = img.width;
        canvas.height = Math.min(chunkHeight, img.height - (i * chunkHeight));

        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, -i * chunkHeight);

        const chunkBlob = await new Promise(resolve => canvas.toBlob(resolve));

        const { data: { text } } = await worker.recognize(chunkBlob);
        fullText += text + '\n\n';
    }

    await worker.terminate();
    return fullText;
}

async function submitToOllama() {
    const text = textArea.value.trim();

    if (!text) {
        alert('No text to submit');
        return;
    }

    const serverUrl = document.getElementById('server-url').value.trim();

    if (!serverUrl) {
        alert('Please enter your local server URL');
        return;
    }

    statusEl.textContent = '‚è≥ Sending to Ollama for AI extraction...';
    statusEl.classList.add('processing');
    submitBtn.disabled = true;

    try {
        const response = await fetch(`${serverUrl}/api/screenshot-text/save`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ text }),
            mode: 'cors'
        });

        if (response.ok) {
            const result = await response.json();
            statusEl.textContent = `‚úÖ Insight extracted! ID: ${result.idea_id || result.recording_id}`;
            statusEl.classList.remove('processing');
            statusEl.classList.add('complete');

            // Auto-redirect to ideas hub
            setTimeout(() => {
                window.location.href = '/ideas/';
            }, 2000);
        } else {
            const errorText = await response.text();
            alert(`Upload failed: ${response.status} - ${errorText}`);
            statusEl.textContent = 'Ready to process screenshot';
            statusEl.classList.remove('processing');
            submitBtn.disabled = false;
        }
    } catch (error) {
        alert(`Error: ${error.message}. Is your local server running with CORS enabled?`);
        statusEl.textContent = 'Ready to process screenshot';
        statusEl.classList.remove('processing');
        submitBtn.disabled = false;
        console.error('Upload error:', error);
    }
}

function clearAll() {
    textArea.value = '';
    preview.style.display = 'none';
    fileInput.value = '';
    statusEl.textContent = 'Ready to process screenshot';
    statusEl.classList.remove('processing', 'complete');
    submitBtn.disabled = true;
}

// Save server URL to localStorage
document.getElementById('server-url').addEventListener('change', (e) => {
    localStorage.setItem('voice-archive-server', e.target.value);
});

// Load saved server URL
window.addEventListener('DOMContentLoaded', () => {
    const savedServer = localStorage.getItem('voice-archive-server');
    if (savedServer) {
        document.getElementById('server-url').value = savedServer;
    }
});
</script>
</body>
</html>
