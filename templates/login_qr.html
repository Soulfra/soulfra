{% extends "base.html" %}

{% block title %}Login with QR Code - {{ config.BLOG_NAME|default('Soulfra') }}{% endblock %}

{% block head %}
<style>
    .qr-login-container {
        max-width: 500px;
        margin: 4rem auto;
        padding: 2rem;
        text-align: center;
    }

    .qr-login-header {
        margin-bottom: 2rem;
    }

    .qr-login-header h1 {
        font-size: 2rem;
        margin-bottom: 0.5rem;
        color: var(--color-text-primary, #111);
    }

    .qr-login-header p {
        color: var(--color-text-secondary, #666);
        font-size: 1rem;
    }

    .qr-code-wrapper {
        background: var(--color-bg-secondary, #f9fafb);
        border: 2px solid var(--color-border, #e5e7eb);
        border-radius: var(--border-radius, 8px);
        padding: 2rem;
        margin: 2rem 0;
    }

    .qr-code-image {
        max-width: 300px;
        width: 100%;
        height: auto;
        margin: 0 auto;
        display: block;
    }

    .qr-code-loading {
        padding: 4rem 2rem;
        color: var(--color-text-secondary, #666);
    }

    .qr-code-spinner {
        display: inline-block;
        width: 40px;
        height: 40px;
        border: 4px solid var(--color-border, #e5e7eb);
        border-top-color: var(--color-primary, #3b82f6);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 1rem;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    .qr-instructions {
        margin-top: 2rem;
        padding: 1.5rem;
        background: var(--color-bg-secondary, #f9fafb);
        border-radius: var(--border-radius, 8px);
        text-align: left;
    }

    .qr-instructions h3 {
        font-size: 1.1rem;
        margin-bottom: 1rem;
        color: var(--color-text-primary, #111);
    }

    .qr-instructions ol {
        margin: 0;
        padding-left: 1.5rem;
    }

    .qr-instructions li {
        margin-bottom: 0.75rem;
        color: var(--color-text-secondary, #666);
    }

    .qr-expiry {
        margin-top: 1rem;
        padding: 0.75rem;
        background: var(--color-warning, #fef3c7);
        border-left: 4px solid var(--color-warning, #f59e0b);
        border-radius: var(--border-radius, 4px);
        font-size: 0.9rem;
        color: var(--color-text-primary, #111);
    }

    .qr-expiry-time {
        font-weight: bold;
        color: var(--color-warning, #f59e0b);
    }

    .qr-refresh-button {
        margin-top: 1.5rem;
        padding: 0.75rem 1.5rem;
        background: var(--color-primary, #3b82f6);
        color: white;
        border: none;
        border-radius: var(--border-radius, 4px);
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.2s;
    }

    .qr-refresh-button:hover {
        background: var(--color-primary-dark, #2563eb);
        transform: translateY(-1px);
    }

    .qr-refresh-button:disabled {
        background: var(--color-border, #e5e7eb);
        color: var(--color-text-tertiary, #9ca3af);
        cursor: not-allowed;
        transform: none;
    }

    .qr-alternative-login {
        margin-top: 2rem;
        padding-top: 2rem;
        border-top: 1px solid var(--color-border, #e5e7eb);
    }

    .qr-alternative-login a {
        color: var(--color-primary, #3b82f6);
        text-decoration: none;
    }

    .qr-alternative-login a:hover {
        text-decoration: underline;
    }

    .qr-success {
        padding: 1rem;
        background: var(--color-success, #10b981);
        color: white;
        border-radius: var(--border-radius, 4px);
        margin-bottom: 1rem;
        display: none;
    }

    .qr-success.show {
        display: block;
    }

    .qr-error {
        padding: 1rem;
        background: var(--color-error, #ef4444);
        color: white;
        border-radius: var(--border-radius, 4px);
        margin-bottom: 1rem;
        display: none;
    }

    .qr-error.show {
        display: block;
    }
</style>
{% endblock %}

{% block content %}
<div class="qr-login-container">
    <!-- Header -->
    <div class="qr-login-header">
        <h1>üì± Login with QR Code</h1>
        <p>Scan the code with your phone to login instantly</p>
    </div>

    <!-- Success Message -->
    <div class="qr-success" id="successMessage">
        ‚úì Logged in successfully! Redirecting...
    </div>

    <!-- Error Message -->
    <div class="qr-error" id="errorMessage">
        ‚úó <span id="errorText">Something went wrong</span>
    </div>

    <!-- QR Code -->
    <div class="qr-code-wrapper">
        <div id="qrCodeLoading" class="qr-code-loading">
            <div class="qr-code-spinner"></div>
            <p>Generating QR code...</p>
        </div>
        <img id="qrCodeImage" class="qr-code-image" style="display: none;" alt="QR Code for Login">
    </div>

    <!-- Expiry Timer -->
    <div class="qr-expiry" id="qrExpiry" style="display: none;">
        ‚è±Ô∏è This QR code expires in <span class="qr-expiry-time" id="expiryTimer">5:00</span>
    </div>

    <!-- Refresh Button -->
    <button class="qr-refresh-button" id="refreshButton" onclick="generateNewQR()" style="display: none;">
        üîÑ Generate New QR Code
    </button>

    <!-- Instructions -->
    <div class="qr-instructions">
        <h3>How to use:</h3>
        <ol>
            <li>Open your phone's camera app</li>
            <li>Point it at the QR code above</li>
            <li>Tap the notification that appears</li>
            <li>You'll be logged in automatically!</li>
        </ol>
    </div>

    <!-- Alternative Login -->
    <div class="qr-alternative-login">
        <p>Prefer traditional login? <a href="/login">Click here</a></p>
    </div>
</div>

<script>
let qrData = null;
let pollInterval = null;
let expiryInterval = null;
let expiresAt = null;

// Generate QR code on page load
window.addEventListener('DOMContentLoaded', () => {
    generateNewQR();
});

async function generateNewQR() {
    // Reset UI
    document.getElementById('qrCodeLoading').style.display = 'block';
    document.getElementById('qrCodeImage').style.display = 'none';
    document.getElementById('refreshButton').style.display = 'none';
    document.getElementById('qrExpiry').style.display = 'none';
    document.getElementById('errorMessage').classList.remove('show');

    // Stop existing intervals
    if (pollInterval) clearInterval(pollInterval);
    if (expiryInterval) clearInterval(expiryInterval);

    try {
        // Request new QR code from server
        const response = await fetch('/api/qr/generate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        if (!response.ok) {
            throw new Error('Failed to generate QR code');
        }

        qrData = await response.json();

        // Display QR code
        document.getElementById('qrCodeImage').src = qrData.qr_image_base64;
        document.getElementById('qrCodeImage').style.display = 'block';
        document.getElementById('qrCodeLoading').style.display = 'none';
        document.getElementById('qrExpiry').style.display = 'block';

        // Set expiry time
        expiresAt = Date.now() + (qrData.expires_in * 1000);

        // Start polling for authentication
        startPolling();

        // Start expiry timer
        startExpiryTimer();

    } catch (error) {
        console.error('Error generating QR code:', error);
        showError('Failed to generate QR code. Please try again.');
        document.getElementById('qrCodeLoading').style.display = 'none';
        document.getElementById('refreshButton').style.display = 'block';
    }
}

function startPolling() {
    // Poll server every 2 seconds to check if QR was scanned
    pollInterval = setInterval(async () => {
        try {
            const response = await fetch(`/api/qr/check/${qrData.token}`);

            if (!response.ok) {
                return;
            }

            const result = await response.json();

            if (result.authenticated) {
                // QR code was scanned and authenticated!
                clearInterval(pollInterval);
                clearInterval(expiryInterval);

                showSuccess();

                // Redirect to dashboard after 1 second
                setTimeout(() => {
                    window.location.href = result.redirect_url || '/dashboard';
                }, 1000);
            }

        } catch (error) {
            console.error('Error polling:', error);
        }
    }, 2000);
}

function startExpiryTimer() {
    updateExpiryDisplay();

    expiryInterval = setInterval(() => {
        updateExpiryDisplay();

        // Check if expired
        const remaining = expiresAt - Date.now();
        if (remaining <= 0) {
            clearInterval(expiryInterval);
            clearInterval(pollInterval);
            handleExpiry();
        }
    }, 1000);
}

function updateExpiryDisplay() {
    const remaining = Math.max(0, expiresAt - Date.now());
    const minutes = Math.floor(remaining / 60000);
    const seconds = Math.floor((remaining % 60000) / 1000);

    const display = `${minutes}:${seconds.toString().padStart(2, '0')}`;
    document.getElementById('expiryTimer').textContent = display;

    // Change color when < 1 minute
    if (minutes < 1) {
        document.getElementById('expiryTimer').style.color = '#ef4444';
    }
}

function handleExpiry() {
    showError('QR code expired. Please generate a new one.');
    document.getElementById('qrCodeImage').style.opacity = '0.3';
    document.getElementById('refreshButton').style.display = 'block';
}

function showSuccess() {
    document.getElementById('successMessage').classList.add('show');
}

function showError(message) {
    document.getElementById('errorText').textContent = message;
    document.getElementById('errorMessage').classList.add('show');
}
</script>
{% endblock %}
