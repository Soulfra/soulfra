<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Domain Manager | Soulfra Admin</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            margin-bottom: 24px;
        }

        h1 {
            font-size: 2.5rem;
            color: #667eea;
            margin-bottom: 8px;
        }

        .subtitle {
            color: #666;
            font-size: 1.1rem;
        }

        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: white;
            padding: 24px;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.15);
        }

        .stat-icon {
            font-size: 48px;
            margin-bottom: 12px;
        }

        .stat-label {
            font-size: 13px;
            color: #999;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 40px;
            font-weight: bold;
            color: #333;
        }

        /* Add Domain Form */
        .action-section {
            background: white;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin-bottom: 24px;
        }

        .section-title {
            font-size: 1.5rem;
            color: #333;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-size: 13px;
            color: #666;
            margin-bottom: 6px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-group input,
        .form-group select {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 50px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(17, 153, 142, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
            color: white;
            padding: 8px 16px;
            font-size: 12px;
        }

        .btn-warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 8px 16px;
            font-size: 12px;
        }

        /* CSV Import */
        .file-upload {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }

        .file-input-wrapper input[type=file] {
            position: absolute;
            left: -9999px;
        }

        .file-input-label {
            padding: 12px 24px;
            background: #f0f0f0;
            border: 2px dashed #ccc;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .file-input-label:hover {
            background: #e0e0e0;
            border-color: #667eea;
        }

        /* Data Table */
        .table-container {
            background: white;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .table-search {
            width: 100%;
            padding: 14px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .table-search:focus {
            outline: none;
            border-color: #667eea;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table thead {
            background: #f8f9fa;
        }

        .data-table th {
            text-align: left;
            padding: 14px;
            color: #666;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-bottom: 2px solid #e0e0e0;
        }

        .data-table td {
            padding: 16px 14px;
            border-bottom: 1px solid #f0f0f0;
            font-size: 14px;
        }

        .data-table tbody tr {
            transition: background 0.2s;
        }

        .data-table tbody tr:hover {
            background: #f8f9fa;
        }

        .domain-badge {
            display: inline-block;
            padding: 4px 12px;
            background: #e3f2fd;
            color: #1976d2;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .tier-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .tier-foundation {
            background: #fff3e0;
            color: #e65100;
        }

        .tier-business {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .tier-creative {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        .actions {
            display: flex;
            gap: 8px;
        }

        /* Flash Messages */
        .flash-messages {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            max-width: 400px;
        }

        .flash {
            padding: 16px 20px;
            margin-bottom: 12px;
            border-radius: 8px;
            color: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            animation: slideIn 0.3s ease;
        }

        .flash-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }

        .flash-error {
            background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
        }

        .flash-warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Edit Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 999;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 16px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .modal-close {
            font-size: 28px;
            cursor: pointer;
            color: #999;
        }

        .modal-close:hover {
            color: #333;
        }
    </style>
</head>
<body>
    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="flash-messages">
                {% for category, message in messages %}
                    <div class="flash flash-{{ category }}">{{ message }}</div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üåê Domain Manager</h1>
            <p class="subtitle">Manage your 200+ domains from one place</p>
        </div>

        <!-- Stats -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">üìä</div>
                <div class="stat-label">Total Brands</div>
                <div class="stat-value">{{ stats.total }}</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">‚úÖ</div>
                <div class="stat-label">With Domains</div>
                <div class="stat-value">{{ stats.with_domains }}</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">‚ö†Ô∏è</div>
                <div class="stat-label">Without Domains</div>
                <div class="stat-value">{{ stats.without_domains }}</div>
            </div>
        </div>

        <!-- Import Multiple Domains (Onboarding Style) -->
        <div class="action-section" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; text-align: center; padding: 40px;">
            <div style="font-size: 3rem; margin-bottom: 16px;">üåê</div>
            <h2 style="font-size: 2rem; margin-bottom: 12px; color: white;">Import Multiple Domains</h2>
            <p style="font-size: 1.1rem; margin-bottom: 24px; opacity: 0.9;">
                Got 10+ domains? Choose your import method:
            </p>
            <div style="display: flex; gap: 16px; justify-content: center; flex-wrap: wrap;">
                <a href="/admin/domains/csv" class="btn" style="display: inline-block; background: white; color: #10b981; font-weight: bold; padding: 16px 40px; border-radius: 50px; text-decoration: none; font-size: 18px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); transition: all 0.3s;">
                    üìÑ Import from CSV
                </a>
                <a href="/admin/domains/import" class="btn" style="display: inline-block; background: rgba(255,255,255,0.9); color: #10b981; font-weight: bold; padding: 16px 40px; border-radius: 50px; text-decoration: none; font-size: 18px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); transition: all 0.3s;">
                    ‚ú® Import with Ollama
                </a>
            </div>
            <p style="margin-top: 16px; font-size: 14px; opacity: 0.8;">
                CSV = Instant (use your templates) ‚Ä¢ Ollama = AI analysis (takes longer)
            </p>
        </div>

        <!-- Quick Add (AI Research) -->
        <div class="action-section" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
            <div class="section-title" style="color: white;">üîç Quick Add - AI Research</div>
            <p style="margin-bottom: 16px; opacity: 0.9;">Just enter a domain name. Ollama will research it and suggest everything!</p>
            <form action="/admin/domains/quick-add" method="POST" style="display: flex; gap: 12px; align-items: center;">
                <input
                    type="text"
                    name="domain"
                    required
                    placeholder="myblog.com"
                    style="flex: 1; padding: 12px 16px; border: 2px solid rgba(255,255,255,0.3); border-radius: 8px; font-size: 16px; background: rgba(255,255,255,0.1); color: white;"
                >
                <button type="submit" class="btn btn-primary" style="background: white; color: #667eea; font-weight: bold; padding: 12px 24px;">
                    üîç Research & Add
                </button>
            </form>
            <p style="margin-top: 12px; font-size: 13px; opacity: 0.8;">
                <strong>What Ollama will do:</strong> Fetch website, DNS lookup, analyze content, suggest category/emoji/tagline
            </p>
        </div>

        <!-- Manual Add (Advanced) -->
        <div class="action-section">
            <div class="section-title">‚ûï Manual Add (Advanced)</div>
            <p style="color: #666; margin-bottom: 16px; font-size: 14px;">Fill in all fields yourself (skip AI research)</p>
            <form action="/admin/domains/add" method="POST">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Name *</label>
                        <input type="text" name="name" required placeholder="StPetePros">
                    </div>
                    <div class="form-group">
                        <label>Domain</label>
                        <input type="text" name="domain" placeholder="stpetepros.com">
                    </div>
                    <div class="form-group">
                        <label>Category</label>
                        <input type="text" name="category" placeholder="tech, creative, business">
                    </div>
                    <div class="form-group">
                        <label>Tier</label>
                        <select name="tier">
                            <option value="foundation">Foundation</option>
                            <option value="business">Business</option>
                            <option value="creative">Creative</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Emoji</label>
                        <input type="text" name="emoji" placeholder="üöÄ" maxlength="2">
                    </div>
                    <div class="form-group">
                        <label>Type</label>
                        <select name="brand_type">
                            <option value="blog">Blog</option>
                            <option value="game">Game</option>
                            <option value="community">Community</option>
                        </select>
                    </div>
                </div>
                <div class="form-group" style="margin-bottom: 20px;">
                    <label>Tagline</label>
                    <input type="text" name="tagline" placeholder="Your brand's tagline">
                </div>
                <button type="submit" class="btn btn-primary">Add Domain</button>
            </form>
        </div>

        <!-- CSV Import -->
        <div class="action-section">
            <div class="section-title">üìÅ Bulk Import from CSV</div>
            <p style="color: #666; margin-bottom: 16px;">
                CSV format: <code>name,domain,category,tier,emoji,brand_type,tagline</code>
            </p>
            <form action="/admin/domains/import-csv" method="POST" enctype="multipart/form-data">
                <div class="file-upload">
                    <div class="file-input-wrapper">
                        <input type="file" name="csv_file" id="csv_file" accept=".csv" required>
                        <label for="csv_file" class="file-input-label">
                            üìÑ Choose CSV File
                        </label>
                    </div>
                    <button type="submit" class="btn btn-success">Import Domains</button>
                </div>
            </form>
            <p style="color: #999; font-size: 12px; margin-top: 12px;">
                üí° <a href="#" onclick="downloadTemplate(); return false;" style="color: #667eea;">Download CSV template</a>
            </p>
        </div>

        <!-- Domains Table -->
        <div class="table-container">
            <div class="section-title">üìã All Domains ({{ stats.total }})</div>
            <input type="text" class="table-search" id="searchInput" placeholder="üîç Search domains, names, categories...">

            <div style="overflow-x: auto;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Emoji</th>
                            <th>Name</th>
                            <th>Domain</th>
                            <th>Slug</th>
                            <th>Category</th>
                            <th>Tier</th>
                            <th>Type</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="domainsTable">
                        {% for brand in brands %}
                        <tr>
                            <td style="font-size: 24px;">{{ brand.emoji or 'üìÑ' }}</td>
                            <td><strong>{{ brand.name }}</strong></td>
                            <td>
                                {% if brand.domain %}
                                    <span class="domain-badge">{{ brand.domain }}</span>
                                {% else %}
                                    <span style="color: #999;">No domain</span>
                                {% endif %}
                            </td>
                            <td><code>{{ brand.slug }}</code></td>
                            <td>{{ brand.category or '-' }}</td>
                            <td>
                                <span class="tier-badge tier-{{ brand.tier or 'foundation' }}">
                                    {{ brand.tier or 'foundation' }}
                                </span>
                            </td>
                            <td>{{ brand.brand_type or 'blog' }}</td>
                            <td>
                                <div class="actions" style="flex-wrap: wrap;">
                                    <button class="btn" style="font-size: 12px; padding: 8px 16px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;" onclick="deployDomain('{{ brand.slug }}')">
                                        üöÄ Deploy
                                    </button>
                                    <button class="btn" style="font-size: 12px; padding: 8px 16px; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white;" onclick="checkStatus('{{ brand.slug }}')">
                                        üìä Status
                                    </button>
                                    <a href="/admin/domains/chat/{{ brand.id }}" class="btn btn-primary" style="font-size: 12px; padding: 8px 16px;">
                                        üí¨ Chat
                                    </a>
                                    <button class="btn btn-warning" onclick="editBrand({{ brand.id }}, '{{ brand.name }}', '{{ brand.domain or '' }}', '{{ brand.category or '' }}', '{{ brand.tier or 'foundation' }}', '{{ brand.emoji or '' }}', '{{ brand.brand_type or 'blog' }}', '{{ brand.tagline or '' }}')">
                                        Edit
                                    </button>
                                    <form action="/admin/domains/delete/{{ brand.id }}" method="POST" style="display: inline;" onsubmit="return confirm('Delete {{ brand.name }}?')">
                                        <button type="submit" class="btn btn-danger">Delete</button>
                                    </form>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div class="modal" id="editModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Domain</h2>
                <span class="modal-close" onclick="closeEditModal()">&times;</span>
            </div>
            <form id="editForm" method="POST">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Name *</label>
                        <input type="text" name="name" id="edit_name" required>
                    </div>
                    <div class="form-group">
                        <label>Domain</label>
                        <input type="text" name="domain" id="edit_domain">
                    </div>
                    <div class="form-group">
                        <label>Category</label>
                        <input type="text" name="category" id="edit_category">
                    </div>
                    <div class="form-group">
                        <label>Tier</label>
                        <select name="tier" id="edit_tier">
                            <option value="foundation">Foundation</option>
                            <option value="business">Business</option>
                            <option value="creative">Creative</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Emoji</label>
                        <input type="text" name="emoji" id="edit_emoji" maxlength="2">
                    </div>
                    <div class="form-group">
                        <label>Type</label>
                        <select name="brand_type" id="edit_brand_type">
                            <option value="blog">Blog</option>
                            <option value="game">Game</option>
                            <option value="community">Community</option>
                        </select>
                    </div>
                </div>
                <div class="form-group" style="margin-top: 16px; margin-bottom: 20px;">
                    <label>Tagline</label>
                    <input type="text" name="tagline" id="edit_tagline">
                </div>
                <button type="submit" class="btn btn-primary">Save Changes</button>
            </form>
        </div>
    </div>

    <script>
        // Search functionality
        document.getElementById('searchInput').addEventListener('keyup', function() {
            const query = this.value.toLowerCase();
            const rows = document.querySelectorAll('#domainsTable tr');

            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(query) ? '' : 'none';
            });
        });

        // Edit modal
        function editBrand(id, name, domain, category, tier, emoji, brand_type, tagline) {
            document.getElementById('edit_name').value = name;
            document.getElementById('edit_domain').value = domain;
            document.getElementById('edit_category').value = category;
            document.getElementById('edit_tier').value = tier;
            document.getElementById('edit_emoji').value = emoji;
            document.getElementById('edit_brand_type').value = brand_type;
            document.getElementById('edit_tagline').value = tagline;

            document.getElementById('editForm').action = '/admin/domains/edit/' + id;
            document.getElementById('editModal').classList.add('active');
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.remove('active');
        }

        // Download CSV template
        function downloadTemplate() {
            const csv = 'name,domain,category,tier,emoji,brand_type,tagline\nExample Site,example.com,tech,foundation,üíª,blog,An example site\nAnother Brand,anotherbrand.com,creative,creative,üé®,blog,Creative solutions';
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'domains-template.csv';
            a.click();
        }

        // Auto-hide flash messages
        setTimeout(() => {
            const flashes = document.querySelectorAll('.flash');
            flashes.forEach(flash => {
                flash.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => flash.remove(), 300);
            });
        }, 5000);

        // ==================== DEPLOYMENT FUNCTIONS ====================

        async function deployDomain(slug) {
            if (!confirm(`Deploy ${slug} using CringeProof template?\n\nThis will:\n1. Create local deployment\n2. Generate theme CSS\n3. Create config.js`)) {
                return;
            }

            const button = event.target;
            button.disabled = true;
            button.textContent = '‚è≥ Deploying...';

            try {
                const response = await fetch(`/api/domains/${slug}/deploy`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({})
                });

                const result = await response.json();

                if (result.success) {
                    alert(`‚úÖ Deployed successfully!\n\nOutput: ${result.output_dir}\nFiles: ${result.files_created.length}`);

                    // Ask if they want to deploy to GitHub too
                    if (confirm('Deploy to GitHub Pages?')) {
                        await deployToGitHub(slug);
                    }
                } else {
                    alert(`‚ùå Deployment failed:\n${result.error}`);
                }
            } catch (error) {
                alert(`‚ùå Error: ${error.message}`);
            } finally {
                button.disabled = false;
                button.textContent = 'üöÄ Deploy';
            }
        }

        async function deployToGitHub(slug) {
            const createRepo = confirm('Create new GitHub repo?\n\nYes = Create new repo\nNo = Use existing repo');

            const button = event.target;
            button.disabled = true;
            button.textContent = '‚è≥ Pushing to GitHub...';

            try {
                const response = await fetch(`/api/domains/${slug}/deploy-github`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({create_repo: createRepo})
                });

                const result = await response.json();

                if (result.success) {
                    alert(`‚úÖ Deployed to GitHub Pages!\n\nURL: ${result.github_pages_url}\nRepo: ${result.repo_name}\n\nNote: GitHub Pages may take 2-3 minutes to go live.`);
                } else {
                    alert(`‚ùå GitHub deployment failed:\n${result.error}`);
                }
            } catch (error) {
                alert(`‚ùå Error: ${error.message}`);
            } finally {
                button.disabled = false;
                button.textContent = 'üöÄ Deploy';
            }
        }

        async function checkStatus(slug) {
            const button = event.target;
            button.disabled = true;
            button.textContent = '‚è≥ Checking...';

            try {
                const response = await fetch(`/api/domains/${slug}/status`);
                const status = await response.json();

                const statusText = `
üìä Deployment Status: ${slug}

‚úÖ Deployed Locally: ${status.deployed_locally ? 'Yes' : 'No'}
‚úÖ Has Git Repo: ${status.has_git_repo ? 'Yes' : 'No'}
‚úÖ GitHub Pages Live: ${status.github_pages_live ? 'Yes' : 'No'}
‚úÖ Backend Accessible: ${status.backend_accessible ? 'Yes' : 'No'}
                `;

                alert(statusText);
            } catch (error) {
                alert(`‚ùå Error checking status: ${error.message}`);
            } finally {
                button.disabled = false;
                button.textContent = 'üìä Status';
            }
        }
    </script>
</body>
</html>
