<!DOCTYPE html>
<html>
<head>
    <title>Database Admin - Soulfra</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; padding: 20px; background: #f5f5f5; }
        h1 { margin-bottom: 20px; }
        .container { max-width: 1400px; margin: 0 auto; }
        .header { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .tables-grid { display: grid; grid-template-columns: 200px 1fr; gap: 20px; }
        .tables-list { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .table-item { padding: 10px; margin-bottom: 5px; cursor: pointer; border-radius: 4px; border: 2px solid transparent; }
        .table-item:hover { background: #f0f0f0; }
        .table-item.active { background: #ff006e; color: white; border-color: #000; }
        .table-content { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .search-bar { margin-bottom: 20px; }
        .search-bar input { width: 300px; padding: 10px; border: 2px solid #ddd; border-radius: 4px; }
        button { background: #ff006e; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: bold; }
        button:hover { background: #dd0058; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background: #f8f8f8; font-weight: 600; }
        tr:hover { background: #f5f5f5; }
        .export-btn { background: #0066ff; margin-left: 10px; }
        .export-btn:hover { background: #0052cc; }
        .email-btn { background: #10b981; }
        .email-btn:hover { background: #059669; }
        .loading { text-align: center; padding: 40px; color: #666; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸ“Š Database Admin - Soulfra</h1>
            <p>SharePoint-like database management</p>
            <button class="email-btn" onclick="exportEmails()">ðŸ“§ Export All Emails (Mailing List)</button>
        </div>

        <div class="tables-grid">
            <div class="tables-list">
                <h3 style="margin-bottom: 15px;">Tables</h3>
                {% for table in tables %}
                <div class="table-item" onclick="loadTable('{{ table }}')" id="table-{{ table }}">
                    <strong>{{ table }}</strong><br>
                    <small style="opacity: 0.7;">{{ table_stats[table] }} rows</small>
                </div>
                {% endfor %}
            </div>

            <div class="table-content">
                <div class="search-bar">
                    <input type="text" id="searchInput" placeholder="Search..." onkeyup="searchTable()">
                    <button onclick="exportCurrentTable()">ðŸ“¥ Export CSV</button>
                </div>

                <div id="tableData">
                    <p style="text-align: center; opacity: 0.5; padding: 40px;">Select a table to view data</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentTable = null;
        let currentData = [];

        function loadTable(tableName) {
            currentTable = tableName;

            // Update active state
            document.querySelectorAll('.table-item').forEach(el => el.classList.remove('active'));
            document.getElementById('table-' + tableName).classList.add('active');

            // Show loading
            document.getElementById('tableData').innerHTML = '<div class="loading">Loading...</div>';

            // Fetch data
            fetch(`/api/admin/table/${tableName}`)
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        currentData = data.data;
                        displayTable(data.columns, data.data, data.total);
                    } else {
                        document.getElementById('tableData').innerHTML = `<p style="color: red;">Error: ${data.error}</p>`;
                    }
                })
                .catch(err => {
                    document.getElementById('tableData').innerHTML = `<p style="color: red;">Failed to load table: ${err}</p>`;
                });
        }

        function displayTable(columns, rows, total) {
            let html = `<p><strong>${total}</strong> total rows (showing ${rows.length})</p>`;
            html += '<table><thead><tr>';

            columns.forEach(col => {
                html += `<th>${col}</th>`;
            });

            html += '</tr></thead><tbody>';

            rows.forEach(row => {
                html += '<tr>';
                columns.forEach(col => {
                    let value = row[col];
                    if (value === null) value = '<em>NULL</em>';
                    if (typeof value === 'string' && value.length > 50) {
                        value = value.substring(0, 50) + '...';
                    }
                    html += `<td>${value}</td>`;
                });
                html += '</tr>';
            });

            html += '</tbody></table>';

            document.getElementById('tableData').innerHTML = html;
        }

        function searchTable() {
            let search = document.getElementById('searchInput').value;
            if (!currentTable) return;

            fetch(`/api/admin/table/${currentTable}?search=${encodeURIComponent(search)}`)
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        displayTable(data.columns, data.data, data.total);
                    }
                });
        }

        function exportCurrentTable() {
            if (!currentTable) {
                alert('Please select a table first');
                return;
            }

            window.location.href = `/api/admin/export/${currentTable}/csv`;
        }

        function exportEmails() {
            window.location.href = '/api/admin/export-emails';
        }
    </script>
</body>
</html>
