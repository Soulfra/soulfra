{% extends "base.html" %}

{% block title %}2+2 Math Game - Soulfra{% endblock %}

{% block content %}
<div style="max-width: 800px; margin: 0 auto; padding: 2rem;">

  <div style="margin-bottom: 2rem;">
    <a href="{{ url_for('games_gallery') }}" style="color: #667eea; text-decoration: none; font-weight: 500;">
      ‚Üê Back to Games
    </a>
  </div>

  <div id="game-container" style="background: white; border-radius: 16px; padding: 3rem; box-shadow: 0 4px 16px rgba(0,0,0,0.1); text-align: center;">

    <!-- Game Header -->
    <div style="font-size: 4rem; margin-bottom: 1rem;">üßÆ</div>
    <h1 style="font-size: 2.5rem; margin-bottom: 0.5rem;">2+2 Math Game</h1>
    <p style="color: #666; font-size: 1.1rem; margin-bottom: 3rem;">
      The simplest possible game - your Soul evolves with every answer!
    </p>

    <!-- Game State -->
    <div id="game-state" style="display: none;">
      <input type="hidden" id="game-id" value="">
      <input type="hidden" id="user-id" value="{{ user_id }}">
    </div>

    <!-- Loading State -->
    <div id="loading-state" style="display: block;">
      <div style="background: #f0f0f0; padding: 2rem; border-radius: 12px; margin-bottom: 2rem;">
        <div style="font-size: 1.2rem; color: #666;">Creating game session...</div>
        <div style="margin-top: 1rem;">
          <div class="spinner" style="display: inline-block; width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite;"></div>
        </div>
      </div>
    </div>

    <!-- Question State -->
    <div id="question-state" style="display: none;">
      <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 3rem; border-radius: 12px; margin-bottom: 2rem;">
        <div style="font-size: 3rem; margin-bottom: 1rem;">‚ùì</div>
        <h2 id="question-text" style="font-size: 2.5rem; margin-bottom: 2rem;">What is 2 + 2?</h2>

        <div style="margin-bottom: 1.5rem;">
          <input type="number"
                 id="answer-input"
                 placeholder="Your answer..."
                 style="font-size: 2rem; padding: 1rem 2rem; border: none; border-radius: 12px; text-align: center; width: 200px; max-width: 100%;"
                 autofocus>
        </div>

        <button id="submit-btn"
                onclick="submitAnswer()"
                style="background: white; color: #667eea; font-size: 1.2rem; font-weight: 600; padding: 1rem 3rem; border: none; border-radius: 12px; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; box-shadow: 0 4px 12px rgba(0,0,0,0.2);">
          Submit Answer
        </button>

        <div style="margin-top: 1.5rem; font-size: 0.95rem; opacity: 0.9;">
          Press Enter to submit
        </div>
      </div>

      <div style="background: #f9f9f9; padding: 1.5rem; border-radius: 8px; font-size: 0.95rem; color: #666;">
        üí° <strong>How it works:</strong> Answer the question ‚Üí AI judges based on your Soul ‚Üí Your expertise updates
      </div>
    </div>

    <!-- Result State -->
    <div id="result-state" style="display: none;">
      <div id="result-content">
        <!-- Will be filled by JavaScript -->
      </div>

      <div style="margin-top: 2rem;">
        <button onclick="playAgain()"
                style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-size: 1.2rem; font-weight: 600; padding: 1rem 3rem; border: none; border-radius: 12px; cursor: pointer; transition: opacity 0.2s;">
          Play Again
        </button>
      </div>

      <div style="margin-top: 2rem;">
        <a href="{{ url_for('games_gallery') }}" style="color: #667eea; text-decoration: none; font-weight: 500;">
          View All Games ‚Üí
        </a>
      </div>
    </div>

  </div>

</div>

<style>
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  #submit-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(0,0,0,0.3);
  }

  #answer-input:focus {
    outline: none;
    box-shadow: 0 0 0 3px rgba(255,255,255,0.3);
  }
</style>

<script>
  // Initialize game
  document.addEventListener('DOMContentLoaded', function() {
    createGame();

    // Allow Enter key to submit
    document.getElementById('answer-input').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        submitAnswer();
      }
    });
  });

  function createGame() {
    fetch('/api/games/create/2plus2', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'}
    })
    .then(r => r.json())
    .then(data => {
      if (data.success) {
        document.getElementById('game-id').value = data.game_id;
        document.getElementById('loading-state').style.display = 'none';
        document.getElementById('question-state').style.display = 'block';
        document.getElementById('question-text').textContent = data.question;
      } else {
        alert('Error creating game: ' + data.error);
      }
    })
    .catch(err => {
      console.error('Error:', err);
      alert('Failed to create game');
    });
  }

  function submitAnswer() {
    const gameId = document.getElementById('game-id').value;
    const answer = document.getElementById('answer-input').value;

    if (!answer) {
      alert('Please enter an answer!');
      return;
    }

    // Disable button
    document.getElementById('submit-btn').disabled = true;
    document.getElementById('submit-btn').textContent = 'Checking...';

    fetch('/api/games/submit-answer', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        game_id: parseInt(gameId),
        answer: answer,
        game_type: '2plus2'
      })
    })
    .then(r => r.json())
    .then(data => {
      if (data.success) {
        showResult(data);
      } else {
        alert('Error: ' + data.error);
        document.getElementById('submit-btn').disabled = false;
        document.getElementById('submit-btn').textContent = 'Submit Answer';
      }
    })
    .catch(err => {
      console.error('Error:', err);
      alert('Failed to submit answer');
      document.getElementById('submit-btn').disabled = false;
      document.getElementById('submit-btn').textContent = 'Submit Answer';
    });
  }

  function showResult(data) {
    // Hide question
    document.getElementById('question-state').style.display = 'none';

    // Build result HTML
    let resultHTML = '';

    if (data.correct) {
      resultHTML = `
        <div style="font-size: 5rem; margin-bottom: 1rem;">‚úÖ</div>
        <h2 style="font-size: 2.5rem; color: #10b981; margin-bottom: 1rem;">CORRECT!</h2>
        <p style="font-size: 1.3rem; color: #666; margin-bottom: 2rem;">
          Yes, 2 + 2 = 4. You know basic math!
        </p>
      `;
    } else {
      resultHTML = `
        <div style="font-size: 5rem; margin-bottom: 1rem;">‚ùå</div>
        <h2 style="font-size: 2.5rem; color: #ef4444; margin-bottom: 1rem;">WRONG!</h2>
        <p style="font-size: 1.3rem; color: #666; margin-bottom: 2rem;">
          Actually, 2 + 2 = 4. Study up on addition!
        </p>
      `;
    }

    // AI Verdict
    if (data.ai_verdict) {
      const verdictColor = data.ai_verdict === 'success' ? '#10b981' : data.ai_verdict === 'failure' ? '#ef4444' : '#f59e0b';
      resultHTML += `
        <div style="background: #f9f9f9; padding: 2rem; border-radius: 12px; margin-bottom: 2rem; text-align: left;">
          <h3 style="font-size: 1.3rem; margin-bottom: 1rem; border-bottom: 2px solid #e0e0e0; padding-bottom: 0.5rem;">
            ü§ñ AI Judgment
          </h3>
          <div style="margin-bottom: 1rem;">
            <strong>Verdict:</strong>
            <span style="color: ${verdictColor}; font-weight: 600; text-transform: uppercase;">
              ${data.ai_verdict}
            </span>
          </div>
          ${data.ai_reasoning ? `
            <div style="margin-bottom: 1rem;">
              <strong>Reasoning:</strong><br>
              <span style="color: #666;">${data.ai_reasoning}</span>
            </div>
          ` : ''}
        </div>
      `;
    }

    // Soul Update
    resultHTML += `
      <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 2rem; border-radius: 12px; text-align: left;">
        <h3 style="font-size: 1.3rem; margin-bottom: 1rem;">
          üß¨ Soul Pack Updated!
        </h3>
        <div style="margin-bottom: 1rem; opacity: 0.9;">
          Your Soul has evolved from this game session.
        </div>
        <div style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 8px; font-family: monospace; font-size: 0.9rem;">
          expertise['2plus2'] ${data.correct ? '++' : '(attempted)'}
        </div>
    `;

    // Show expertise breakdown
    if (data.expertise) {
      const expertiseList = Object.entries(data.expertise)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5)
        .map(([skill, score]) => `<div>${skill}: ${score}</div>`)
        .join('');

      resultHTML += `
        <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid rgba(255,255,255,0.2);">
          <strong>Top Expertise:</strong>
          <div style="margin-top: 0.5rem; font-size: 0.9rem; opacity: 0.9;">
            ${expertiseList}
          </div>
        </div>
      `;
    }

    resultHTML += `</div>`;

    // Show result
    document.getElementById('result-content').innerHTML = resultHTML;
    document.getElementById('result-state').style.display = 'block';
  }

  function playAgain() {
    // Reset state
    document.getElementById('result-state').style.display = 'none';
    document.getElementById('loading-state').style.display = 'block';
    document.getElementById('answer-input').value = '';
    document.getElementById('submit-btn').disabled = false;
    document.getElementById('submit-btn').textContent = 'Submit Answer';

    // Create new game
    createGame();
  }
</script>

{% endblock %}
