#!/usr/bin/env python3
"""
Soul Transformer - Convert Soul Packs to Platform-Specific Formats

The "Ventrilo for Souls" - one identity, many platforms.

Takes a Soul Pack (JSON) and transforms it for different platforms:
- Roblox ‚Üí Lua ModuleScript
- Minecraft ‚Üí JSON player data
- Unity/Unreal ‚Üí JSON asset bundle
- Web ‚Üí HTML/CSS profile (already exists via templates)
- Voice/AI ‚Üí Persona configuration

Flow:
    QR Scan ‚Üí Choose Platform ‚Üí Transform Soul ‚Üí Load into Platform

Usage:
    from soul_transformer import SoulTransformer

    transformer = SoulTransformer()
    soul_pack = transformer.load_soul(user_id=1)

    # Transform for Roblox
    lua_code = transformer.to_roblox(soul_pack)

    # Transform for Minecraft
    mc_data = transformer.to_minecraft(soul_pack)

    # CLI:
    python3 soul_transformer.py --user 1 --platform roblox
"""

import json
import sqlite3
from typing import Dict, Any, Optional
from pathlib import Path
from soul_model import Soul


class SoulTransformer:
    """
    Transforms Soul Packs into platform-specific formats
    """

    def __init__(self, db_path: str = 'soulfra.db'):
        self.db_path = db_path

    # ==========================================================================
    # CORE: Load Soul Pack
    # ==========================================================================

    def load_soul(self, user_id: int) -> Dict[str, Any]:
        """
        Load a Soul Pack for a user

        Returns:
            Soul Pack dict with identity, essence, expression, connections, evolution
        """
        try:
            soul = Soul(user_id)

            soul_pack = {
                'version': '1.0',
                'user_id': user_id,
                'identity': soul.get_identity(),
                'essence': {
                    'interests': soul.extract_interests(top_n=10),
                    'expertise': soul.extract_expertise(),
                    'values': soul.detect_values()
                },
                'expression': soul.get_expression(),
                'connections': soul.get_connections(),
                'evolution': soul.get_evolution()
            }

            return soul_pack

        except Exception as e:
            print(f"[ERROR] Failed to load soul for user {user_id}: {e}")
            return {}

    # ==========================================================================
    # PLATFORM 1: Roblox (Lua ModuleScript)
    # ==========================================================================

    def to_roblox(self, soul_pack: Dict[str, Any]) -> str:
        """
        Transform Soul Pack to Roblox Lua ModuleScript

        Output can be loaded into Roblox game as:
        - Character data
        - Avatar properties
        - Chat permissions (enforcing terms)
        - Stats/attributes

        Returns:
            Lua code string
        """
        identity = soul_pack.get('identity', {})
        essence = soul_pack.get('essence', {})
        expression = soul_pack.get('expression', {})

        username = identity.get('username', 'Unknown')
        interests = essence.get('interests', [])
        values = essence.get('values', [])
        post_count = expression.get('post_count', 0)

        # Build Lua module
        lua_code = f"""-- Soul Pack: {username}
-- Generated by Soulfra Transformer
-- Version: {soul_pack.get('version', '1.0')}

local Soul = {{}}

-- ========== IDENTITY ==========
Soul.Identity = {{
    UserId = {soul_pack.get('user_id', 0)},
    Username = "{username}",
    DisplayName = "{identity.get('display_name', username)}",
    IsAI = {str(identity.get('is_ai_persona', False)).lower()},
    JoinedAt = "{identity.get('created_at', 'Unknown')}"
}}

-- ========== ESSENCE ==========
Soul.Essence = {{
    Interests = {{{', '.join([f'"{i}"' for i in interests[:5]])}}},
    Values = {{{', '.join([f'"{v}"' for v in values[:5]])}}},
    Expertise = {{
"""

        # Add expertise scores
        expertise = essence.get('expertise', {})
        for skill, score in list(expertise.items())[:5]:
            lua_code += f'        ["{skill}"] = {score},\n'

        lua_code += """    }
}

-- ========== EXPRESSION ==========
Soul.Expression = {
    PostCount = """ + str(post_count) + """,
    CommentCount = """ + str(expression.get('comment_count', 0)) + """,
    HasCode = """ + str(expression.get('has_code', False)).lower() + """
}

-- ========== CHAT RULES (Terms Enforcement) ==========
Soul.ChatRules = {
    -- Auto-moderation based on Soulfra terms
    AllowedTopics = Soul.Essence.Interests,
    BlockedWords = {"password", "credit card", "ssn"},  -- Privacy protection
    MaxMessageLength = 500,
    RequireRespect = true  -- Enforces respectful communication
}

-- ========== AVATAR CONFIG ==========
Soul.Avatar = {
    -- Generated from username hash (deterministic)
    ColorScheme = {
        Primary = Color3.fromRGB(""" + str(hash(username) % 255) + """, """ + str((hash(username) // 255) % 255) + """, """ + str((hash(username) // (255*255)) % 255) + """),
        Secondary = Color3.fromRGB(""" + str((hash(username) * 7) % 255) + """, """ + str((hash(username) * 13) % 255) + """, """ + str((hash(username) * 19) % 255) + """)
    },

    -- Stats based on activity
    Level = math.floor(Soul.Expression.PostCount / 10) + 1,
    Experience = Soul.Expression.PostCount * 100
}

-- ========== API INTEGRATION ==========
Soul.API = {
    BaseURL = "http://localhost:5000",  -- TODO: Config
    GetProfile = function()
        return Soul.API.BaseURL .. "/@" .. Soul.Identity.Username
    end,

    SyncData = function(newData)
        -- POST updates back to Soulfra
        -- Keeps identity synchronized across platforms
        local HttpService = game:GetService("HttpService")
        local url = Soul.API.BaseURL .. "/api/soul/sync"
        -- Implementation depends on Roblox HttpService
    end
}

-- ========== HELPER FUNCTIONS ==========
function Soul:GetSummary()
    return string.format(
        "%s (Lvl %d) - Interests: %s",
        self.Identity.DisplayName,
        self.Avatar.Level,
        table.concat(self.Essence.Interests, ", ")
    )
end

function Soul:EnforceChatRules(message)
    -- Check message against chat rules
    for _, blocked in ipairs(self.ChatRules.BlockedWords) do
        if string.lower(message):find(blocked) then
            return false, "Message contains blocked content"
        end
    end

    if #message > self.ChatRules.MaxMessageLength then
        return false, "Message too long"
    end

    return true, "OK"
end

return Soul
"""

        return lua_code

    # ==========================================================================
    # PLATFORM 2: Minecraft (JSON Player Data)
    # ==========================================================================

    def to_minecraft(self, soul_pack: Dict[str, Any]) -> Dict[str, Any]:
        """
        Transform Soul Pack to Minecraft player data format

        Output format compatible with:
        - Player.dat NBT structure (can be converted)
        - Mod data (Forge/Fabric)
        - Server plugins (Spigot/Paper)

        Returns:
            Dict that can be JSON-serialized or converted to NBT
        """
        identity = soul_pack.get('identity', {})
        essence = soul_pack.get('essence', {})
        expression = soul_pack.get('expression', {})

        username = identity.get('username', 'Unknown')

        minecraft_data = {
            'DataVersion': 3218,  # Minecraft 1.20
            'soulfra': {  # Custom mod data
                'version': soul_pack.get('version', '1.0'),
                'user_id': soul_pack.get('user_id', 0),
                'username': username,
                'display_name': identity.get('display_name', username),

                # Player attributes based on Soul
                'attributes': {
                    'intelligence': min(len(essence.get('interests', [])) * 2, 20),
                    'creativity': expression.get('post_count', 0) // 5,
                    'social': len(soul_pack.get('connections', {}).get('interacts_with', [])),
                },

                # Custom inventory items representing interests
                'soul_items': [
                    {
                        'id': 'minecraft:book',
                        'tag': {
                            'display': {
                                'Name': f'"{interest} Knowledge"',
                                'Lore': [f'"Interest: {interest}"']
                            }
                        }
                    }
                    for interest in essence.get('interests', [])[:9]
                ],

                # Chat rules enforcement
                'chat_rules': {
                    'allowed_topics': essence.get('interests', []),
                    'blocked_words': ['password', 'credit card', 'ssn'],
                    'max_message_length': 256,
                    'require_respect': True
                },

                # Skin data (base64 encoded texture URL)
                'skin': {
                    'url': f'http://localhost:5000/api/avatar/{username}.png',
                    'model': 'default'  # or 'slim'
                },

                # Sync API
                'api': {
                    'base_url': 'http://localhost:5000',
                    'profile_url': f'/@{username}',
                    'sync_endpoint': '/api/soul/sync'
                }
            }
        }

        return minecraft_data

    # ==========================================================================
    # PLATFORM 3: Unity/Unreal (JSON Asset Bundle)
    # ==========================================================================

    def to_unity(self, soul_pack: Dict[str, Any]) -> Dict[str, Any]:
        """
        Transform Soul Pack to Unity asset bundle format

        Output format compatible with:
        - Unity ScriptableObject JSON
        - Unreal Engine DataAsset JSON
        - Generic game engine character data

        Returns:
            JSON asset bundle
        """
        identity = soul_pack.get('identity', {})
        essence = soul_pack.get('essence', {})
        expression = soul_pack.get('expression', {})

        username = identity.get('username', 'Unknown')

        unity_asset = {
            '$schema': 'soulfra-soul-v1.0',
            'assetType': 'CharacterData',
            'name': username,

            'identity': {
                'userId': soul_pack.get('user_id', 0),
                'username': username,
                'displayName': identity.get('display_name', username),
                'isAI': identity.get('is_ai_persona', False),
                'joinedAt': identity.get('created_at', '')
            },

            'attributes': {
                # Stats derived from Soul
                'level': expression.get('post_count', 0) // 10 + 1,
                'experience': expression.get('post_count', 0) * 100,
                'intelligence': len(essence.get('interests', [])) * 2,
                'creativity': expression.get('post_count', 0) // 5,
                'social': len(soul_pack.get('connections', {}).get('interacts_with', [])),
                'karma': expression.get('post_count', 0) + expression.get('comment_count', 0)
            },

            'skills': essence.get('expertise', {}),

            'tags': essence.get('interests', [])[:10],

            'appearance': {
                # Color scheme from username hash
                'primaryColor': {
                    'r': (hash(username) % 255) / 255.0,
                    'g': ((hash(username) // 255) % 255) / 255.0,
                    'b': ((hash(username) // (255*255)) % 255) / 255.0,
                    'a': 1.0
                },
                'avatarUrl': f'http://localhost:5000/api/avatar/{username}.png',
                'modelType': 'humanoid'
            },

            'behavior': {
                'chatRules': {
                    'allowedTopics': essence.get('interests', []),
                    'blockedWords': ['password', 'credit card', 'ssn'],
                    'maxMessageLength': 500,
                    'requireRespect': True
                },
                'values': essence.get('values', [])
            },

            'api': {
                'baseUrl': 'http://localhost:5000',
                'profileUrl': f'/@{username}',
                'syncEndpoint': '/api/soul/sync'
            }
        }

        return unity_asset

    # ==========================================================================
    # PLATFORM 4: Voice/AI (Persona Config)
    # ==========================================================================

    def to_voice_persona(self, soul_pack: Dict[str, Any]) -> Dict[str, Any]:
        """
        Transform Soul Pack to AI persona configuration

        Output format for voice bots / AI assistants:
        - Personality traits
        - Speaking style
        - Knowledge domains
        - Chat rules

        Returns:
            AI persona config
        """
        identity = soul_pack.get('identity', {})
        essence = soul_pack.get('essence', {})
        expression = soul_pack.get('expression', {})

        username = identity.get('username', 'Unknown')
        interests = essence.get('interests', [])
        values = essence.get('values', [])

        persona_config = {
            'persona_id': soul_pack.get('user_id', 0),
            'name': identity.get('display_name', username),
            'username': username,

            'personality': {
                'traits': values[:5] if values else ['helpful', 'curious', 'respectful'],
                'speaking_style': 'friendly' if 'community' in values else 'professional',
                'formality': 'casual' if expression.get('post_count', 0) > 20 else 'formal',
                'emoji_usage': expression.get('has_code', False)  # Techies use fewer emojis
            },

            'knowledge': {
                'domains': interests[:10],
                'expertise_levels': essence.get('expertise', {}),
                'experience_points': expression.get('post_count', 0) * 100
            },

            'behavior': {
                'chat_rules': {
                    'allowed_topics': interests,
                    'blocked_content': ['personal_info', 'harmful_content'],
                    'max_response_length': 500,
                    'require_respect': True
                },
                'response_style': {
                    'verbosity': 'moderate',
                    'technical_depth': 'adaptive',  # Matches user's level
                    'examples': True if 'transparency' in values else False
                }
            },

            'voice': {
                'provider': 'system_tts',  # or 'eleven_labs', 'google', etc.
                'voice_id': f'soulfra_{username}',
                'speed': 1.0,
                'pitch': 1.0
            },

            'api': {
                'base_url': 'http://localhost:5000',
                'sync_endpoint': '/api/soul/sync',
                'profile_url': f'/@{username}'
            }
        }

        return persona_config

    # ==========================================================================
    # PLATFORM 5: Web (HTML/CSS) - Reference Existing System
    # ==========================================================================

    def to_web(self, soul_pack: Dict[str, Any]) -> str:
        """
        Transform Soul Pack to web profile

        NOTE: This already exists via the Soulfra Simple Builder!
        This method just returns the URL.

        See:
        - soulfra_simple_builder.py
        - templates/generated/user_{id}/homepage.html

        Returns:
            URL to web profile
        """
        username = soul_pack.get('identity', {}).get('username', 'unknown')
        user_id = soul_pack.get('user_id', 0)

        return f"http://localhost:5000/@{username}"

    # ==========================================================================
    # UTILITY: Export to File
    # ==========================================================================

    def export(self, soul_pack: Dict[str, Any], platform: str, output_path: Optional[str] = None) -> str:
        """
        Export Soul Pack to platform-specific file

        Args:
            soul_pack: Soul Pack dict
            platform: 'roblox', 'minecraft', 'unity', 'voice', 'web'
            output_path: Optional output file path

        Returns:
            Path to exported file
        """
        username = soul_pack.get('identity', {}).get('username', 'unknown')

        if output_path is None:
            output_dir = Path('exports') / 'souls' / username
            output_dir.mkdir(parents=True, exist_ok=True)
        else:
            output_dir = Path(output_path).parent
            output_dir.mkdir(parents=True, exist_ok=True)

        if platform == 'roblox':
            lua_code = self.to_roblox(soul_pack)
            file_path = output_dir / f'{username}_soul.lua' if output_path is None else output_path
            with open(file_path, 'w') as f:
                f.write(lua_code)

        elif platform == 'minecraft':
            mc_data = self.to_minecraft(soul_pack)
            file_path = output_dir / f'{username}_minecraft.json' if output_path is None else output_path
            with open(file_path, 'w') as f:
                json.dump(mc_data, f, indent=2)

        elif platform == 'unity':
            unity_asset = self.to_unity(soul_pack)
            file_path = output_dir / f'{username}_unity.json' if output_path is None else output_path
            with open(file_path, 'w') as f:
                json.dump(unity_asset, f, indent=2)

        elif platform == 'voice':
            persona_config = self.to_voice_persona(soul_pack)
            file_path = output_dir / f'{username}_persona.json' if output_path is None else output_path
            with open(file_path, 'w') as f:
                json.dump(persona_config, f, indent=2)

        elif platform == 'web':
            web_url = self.to_web(soul_pack)
            file_path = output_dir / f'{username}_web.txt' if output_path is None else output_path
            with open(file_path, 'w') as f:
                f.write(f"Web Profile URL:\n{web_url}\n")

        else:
            raise ValueError(f"Unknown platform: {platform}")

        return str(file_path)


# ==============================================================================
# CLI
# ==============================================================================

if __name__ == '__main__':
    import argparse

    parser = argparse.ArgumentParser(description='Soul Transformer - Convert Souls to Platform Formats')
    parser.add_argument('--user', type=int, required=True, help='User ID to transform')
    parser.add_argument('--platform', choices=['roblox', 'minecraft', 'unity', 'voice', 'web'], required=True, help='Target platform')
    parser.add_argument('--output', help='Output file path (optional)')
    parser.add_argument('--print', action='store_true', help='Print output to console instead of file')

    args = parser.parse_args()

    transformer = SoulTransformer()

    print(f"\nüîÑ Loading Soul for user {args.user}...")
    soul_pack = transformer.load_soul(args.user)

    if not soul_pack:
        print("‚ùå Failed to load Soul")
        exit(1)

    username = soul_pack.get('identity', {}).get('username', 'unknown')
    print(f"‚úÖ Loaded Soul: {username}\n")

    print(f"üéÆ Transforming for platform: {args.platform}...")

    if args.print:
        # Print to console
        if args.platform == 'roblox':
            print(transformer.to_roblox(soul_pack))
        elif args.platform == 'minecraft':
            print(json.dumps(transformer.to_minecraft(soul_pack), indent=2))
        elif args.platform == 'unity':
            print(json.dumps(transformer.to_unity(soul_pack), indent=2))
        elif args.platform == 'voice':
            print(json.dumps(transformer.to_voice_persona(soul_pack), indent=2))
        elif args.platform == 'web':
            print(transformer.to_web(soul_pack))
    else:
        # Export to file
        file_path = transformer.export(soul_pack, args.platform, args.output)
        print(f"‚úÖ Exported to: {file_path}\n")
