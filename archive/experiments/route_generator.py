#!/usr/bin/env python3
"""
Route Generator - Auto-Create Flask Routes

Automatically generates Flask routes for database tables and dashboards.

Features:
- Generate routes for all tables
- Auto-wire to dashboard templates
- CRUD API endpoints
- Export endpoints (CSV, JSON)
- Admin authentication built-in

Usage:
    from route_generator import generate_routes_code

    # Generate routes code for all tables
    code = generate_routes_code()

    # Save to file
    python3 route_generator.py --generate --output auto_routes.py
"""

from typing import List, Dict
from schema_inspector import get_all_tables, get_table_schema, get_table_summary


# ==============================================================================
# ROUTE CODE GENERATION
# ==============================================================================

def generate_route_code(table_name: str) -> str:
    """
    Generate Flask route code for a table

    Returns:
        Python code string with Flask routes
    """
    schema = get_table_schema(table_name)
    summary = get_table_summary(table_name)

    # Get columns for queries
    columns = [col['name'] for col in schema['columns']]
    numeric_cols = summary['numeric_columns']

    route_code = f'''
# ==============================================================================
# AUTO-GENERATED ROUTES FOR {table_name.upper()}
# ==============================================================================

@app.route('/admin/{table_name}')
def admin_{table_name}():
    """Auto-generated dashboard for {table_name}"""
    # Admin access check
    if not session.get('is_admin'):
        flash('Admin access required', 'error')
        return redirect('/login')

    conn = get_db()

    # Get all records
    rows = conn.execute(\'\'\'
        SELECT * FROM {table_name}
        ORDER BY {columns[0]} DESC
        LIMIT 100
    \'\'\').fetchall()

    # Calculate stats
    stats = {{}}
'''

    # Add stats calculations for numeric columns
    for col in numeric_cols[:5]:  # Limit to 5 stats
        route_code += f'''
    stats['{col}'] = conn.execute(\'\'\'
        SELECT SUM({col}) as total FROM {table_name}
    \'\'\').fetchone()['total'] or 0
'''

    route_code += f'''
    conn.close()

    return render_template('admin_{table_name}.html',
                         rows=[dict(r) for r in rows],
                         stats=stats)


@app.route('/admin/{table_name}/export')
def admin_{table_name}_export():
    """Export {table_name} data as CSV"""
    if not session.get('is_admin'):
        return jsonify({{'error': 'Unauthorized'}}), 401

    import csv
    import io

    conn = get_db()
    rows = conn.execute('SELECT * FROM {table_name}').fetchall()
    conn.close()

    # Create CSV
    output = io.StringIO()
    writer = csv.DictWriter(output, fieldnames={columns})
    writer.writeheader()
    for row in rows:
        writer.writerow(dict(row))

    # Return as downloadable file
    from flask import Response
    return Response(
        output.getvalue(),
        mimetype='text/csv',
        headers={{'Content-Disposition': f'attachment; filename={table_name}.csv'}}
    )
'''

    return route_code


def generate_routes_code() -> str:
    """
    Generate routes for all database tables

    Returns:
        Complete Python code with all routes
    """
    tables = get_all_tables()

    code = '''#!/usr/bin/env python3
"""
Auto-Generated Routes
Generated by route_generator.py

WARNING: This file is auto-generated. Do not edit manually.
To regenerate: python3 route_generator.py --generate --output auto_routes.py
"""

from flask import render_template, request, redirect, url_for, flash, session, jsonify
from database import get_db

# Import these functions into your main app.py
# Then call: register_auto_routes(app)

def register_auto_routes(app):
    """Register all auto-generated routes"""

'''

    for table in tables:
        try:
            code += generate_route_code(table)
        except Exception as e:
            code += f"\n    # Failed to generate routes for {table}: {e}\n"

    return code


# ==============================================================================
# SAVE & LOAD
# ==============================================================================

def save_routes_code(filepath: str = 'auto_routes.py') -> str:
    """
    Generate and save routes code to file

    Args:
        filepath: Where to save the generated code

    Returns:
        Path to saved file
    """
    code = generate_routes_code()

    with open(filepath, 'w') as f:
        f.write(code)

    print(f"✅ Routes saved to {filepath}")
    print(f"   Add to app.py:")
    print(f"   from auto_routes import register_auto_routes")
    print(f"   register_auto_routes(app)")

    return filepath


# ==============================================================================
# INLINE ROUTE REGISTRATION
# ==============================================================================

def register_table_routes(app, table_name: str):
    """
    Dynamically register routes for a table (without code generation)

    This adds routes directly to the Flask app at runtime.
    """
    from flask import render_template, session, redirect, flash, jsonify
    from database import get_db

    schema = get_table_schema(table_name)
    summary = get_table_summary(table_name)

    # Dashboard route
    @app.route(f'/admin/{table_name}')
    def dynamic_dashboard():
        if not session.get('is_admin'):
            flash('Admin access required', 'error')
            return redirect('/login')

        conn = get_db()
        rows = conn.execute(f'SELECT * FROM {table_name} ORDER BY rowid DESC LIMIT 100').fetchall()

        # Calculate stats
        stats = {}
        for col in summary['numeric_columns'][:5]:
            total = conn.execute(f'SELECT SUM({col}) as total FROM {table_name}').fetchone()['total']
            stats[col] = total or 0

        conn.close()

        return render_template(f'admin_{table_name}.html',
                             rows=[dict(r) for r in rows],
                             stats=stats)

    # Export route
    @app.route(f'/admin/{table_name}/export')
    def dynamic_export():
        if not session.get('is_admin'):
            return jsonify({'error': 'Unauthorized'}), 401

        import csv
        import io
        from flask import Response

        conn = get_db()
        rows = conn.execute(f'SELECT * FROM {table_name}').fetchall()
        conn.close()

        output = io.StringIO()
        if rows:
            writer = csv.DictWriter(output, fieldnames=rows[0].keys())
            writer.writeheader()
            for row in rows:
                writer.writerow(dict(row))

        return Response(
            output.getvalue(),
            mimetype='text/csv',
            headers={'Content-Disposition': f'attachment; filename={table_name}.csv'}
        )

    print(f"✅ Registered routes for {table_name}: /admin/{table_name}, /admin/{table_name}/export")


def register_all_table_routes(app):
    """Register routes for all database tables dynamically"""
    tables = get_all_tables()

    for table in tables:
        try:
            register_table_routes(app, table)
        except Exception as e:
            print(f"❌ Failed to register routes for {table}: {e}")

    print(f"\n✅ Registered routes for {len(tables)} tables")


# ==============================================================================
# CLI
# ==============================================================================

if __name__ == '__main__':
    import argparse

    parser = argparse.ArgumentParser(description='Route Generator')
    parser.add_argument('--generate', action='store_true', help='Generate routes code')
    parser.add_argument('--output', default='auto_routes.py', help='Output file path')
    parser.add_argument('--table', metavar='TABLE', help='Generate routes for specific table')
    parser.add_argument('--preview', action='store_true', help='Print code to stdout')

    args = parser.parse_args()

    if args.table:
        code = generate_route_code(args.table)
        if args.preview:
            print(code)
        else:
            print(f"✅ Generated route code for {args.table}")

    elif args.generate:
        code = generate_routes_code()

        if args.preview:
            print(code)
        else:
            save_routes_code(args.output)

    else:
        parser.print_help()
