#!/usr/bin/env python3
"""
Bash Script Templates

Code generators for common bash scripting patterns including:
- Deployment scripts
- For loop iterations
- Packaging/bundling scripts
- Test runners with parallel execution
- Error handling patterns
"""

CATEGORY = 'bash'

# =============================================================================
# TEMPLATE GENERATORS
# =============================================================================

def generate_deployment_script(
    app_name='app',
    build_command='python build.py',
    test_command='python -m pytest',
    deploy_target='docs/',
    **kwargs
):
    """Generate deployment bash script"""

    return f'''#!/bin/bash
# Deployment script for {app_name}
# Auto-generated by templates_lib/bash.py

set -e  # Exit on error
set -u  # Exit on undefined variable

echo "üöÄ Deploying {app_name}..."

# Step 1: Run tests
echo "üìù Running tests..."
{test_command}
echo "‚úÖ Tests passed"

# Step 2: Build
echo "üî® Building..."
{build_command}
echo "‚úÖ Build complete"

# Step 3: Deploy
echo "üì¶ Deploying to {deploy_target}..."
if [ -d "{deploy_target}" ]; then
    echo "  Deployment directory exists"
else
    echo "  Creating deployment directory"
    mkdir -p "{deploy_target}"
fi

echo "‚úÖ Deployment complete!"
echo ""
echo "Next steps:"
echo "  - Commit changes: git add . && git commit -m 'Deploy'"
echo "  - Push to remote: git push origin main"
'''


def generate_for_loop_script(
    loop_items='*.txt',
    loop_command='echo "Processing $file"',
    parallel=False,
    **kwargs
):
    """Generate bash script with for loop"""

    if parallel:
        return f'''#!/bin/bash
# Parallel for loop iteration
# Auto-generated by templates_lib/bash.py

set -e

# Process files in parallel
for file in {loop_items}; do
    (
        echo "Processing $file..."
        {loop_command}
        echo "‚úÖ Completed $file"
    ) &
done

# Wait for all background jobs
wait

echo "‚úÖ All files processed!"
'''
    else:
        return f'''#!/bin/bash
# Sequential for loop iteration
# Auto-generated by templates_lib/bash.py

set -e

for file in {loop_items}; do
    echo "Processing $file..."
    {loop_command}
    echo "‚úÖ Completed $file"
done

echo "‚úÖ All files processed!"
'''


def generate_packaging_script(
    package_name='app',
    version='1.0.0',
    files_to_include='*.py *.md templates/ migrations/',
    output_dir='dist/',
    **kwargs
):
    """Generate packaging/bundling bash script"""

    return f'''#!/bin/bash
# Packaging script for {package_name}
# Auto-generated by templates_lib/bash.py

set -e
set -u

PACKAGE_NAME="{package_name}"
VERSION="{version}"
OUTPUT_DIR="{output_dir}"
ARCHIVE_NAME="${{PACKAGE_NAME}}-${{VERSION}}.tar.gz"

echo "üì¶ Packaging ${{PACKAGE_NAME}} v${{VERSION}}..."

# Create output directory
mkdir -p "$OUTPUT_DIR"

# Create temporary staging directory
STAGING_DIR=$(mktemp -d)
echo "  Staging directory: $STAGING_DIR"

# Copy files to staging
echo "  Copying files..."
for item in {files_to_include}; do
    if [ -e "$item" ]; then
        cp -r "$item" "$STAGING_DIR/"
        echo "    ‚úì $item"
    fi
done

# Create tarball
echo "  Creating archive..."
cd "$STAGING_DIR"
tar -czf "$ARCHIVE_NAME" ./*
mv "$ARCHIVE_NAME" "$OLDPWD/$OUTPUT_DIR/"
cd "$OLDPWD"

# Cleanup
rm -rf "$STAGING_DIR"

echo "‚úÖ Package created: $OUTPUT_DIR/$ARCHIVE_NAME"
echo ""
echo "Package contents:"
tar -tzf "$OUTPUT_DIR/$ARCHIVE_NAME" | head -20
'''


def generate_test_runner(
    test_pattern='test_*.py',
    parallel=True,
    verbose=True,
    **kwargs
):
    """Generate test runner bash script"""

    if parallel:
        runner = 'pytest -n auto' if verbose else 'pytest -n auto -q'
    else:
        runner = 'pytest -v' if verbose else 'pytest'

    return f'''#!/bin/bash
# Test runner script
# Auto-generated by templates_lib/bash.py

set -e

echo "üß™ Running tests..."

# Find all test files
TEST_FILES=$(find . -name '{test_pattern}' -type f)

if [ -z "$TEST_FILES" ]; then
    echo "‚ùå No test files found matching '{test_pattern}'"
    exit 1
fi

echo "Found tests:"
echo "$TEST_FILES" | while read -r file; do
    echo "  - $file"
done
echo ""

# Run tests
{runner}

echo ""
echo "‚úÖ All tests passed!"
'''


def generate_error_handling_script(
    main_command='python app.py',
    log_file='error.log',
    **kwargs
):
    """Generate bash script with comprehensive error handling"""

    return f'''#!/bin/bash
# Script with error handling
# Auto-generated by templates_lib/bash.py

set -e  # Exit on error
set -u  # Exit on undefined variable
set -o pipefail  # Exit on pipe failure

LOG_FILE="{log_file}"

# Error handler
error_handler() {{
    echo "‚ùå Error on line $1" | tee -a "$LOG_FILE"
    echo "Command: $BASH_COMMAND" | tee -a "$LOG_FILE"
    echo "Timestamp: $(date)" | tee -a "$LOG_FILE"
    exit 1
}}

# Cleanup handler
cleanup_handler() {{
    echo "üßπ Cleaning up..."
    # Add cleanup commands here
}}

# Set up traps
trap 'error_handler ${{LINENO}}' ERR
trap cleanup_handler EXIT

# Main execution
echo "üöÄ Starting {main_command}..."
{main_command}

echo "‚úÖ Completed successfully!"
'''


def generate_ci_pipeline(
    app_name='app',
    python_version='3.8',
    **kwargs
):
    """Generate CI/CD pipeline bash script"""

    return f'''#!/bin/bash
# CI/CD Pipeline for {app_name}
# Auto-generated by templates_lib/bash.py

set -e
set -u

echo "üîÑ CI/CD Pipeline Starting..."

# Stage 1: Setup
echo "üì¶ Stage 1: Setup"
echo "  Python version: {python_version}"
python{python_version} --version || (echo "Python {python_version} not found" && exit 1)

# Stage 2: Install dependencies
echo "üì• Stage 2: Install Dependencies"
if [ -f "requirements.txt" ]; then
    pip install -r requirements.txt
    echo "  ‚úì Dependencies installed"
else
    echo "  ‚ö†Ô∏è  No requirements.txt found"
fi

# Stage 3: Lint
echo "üîç Stage 3: Linting"
if command -v pylint &> /dev/null; then
    pylint *.py || echo "  ‚ö†Ô∏è  Linting warnings"
else
    echo "  ‚ö†Ô∏è  pylint not installed, skipping"
fi

# Stage 4: Test
echo "üß™ Stage 4: Testing"
if [ -d "tests" ] || ls test_*.py &> /dev/null; then
    pytest -v
    echo "  ‚úì Tests passed"
else
    echo "  ‚ö†Ô∏è  No tests found"
fi

# Stage 5: Build
echo "üî® Stage 5: Building"
if [ -f "build.py" ]; then
    python build.py
    echo "  ‚úì Build complete"
else
    echo "  ‚ö†Ô∏è  No build script found"
fi

# Stage 6: Deploy
echo "üöÄ Stage 6: Deploy"
if [ -f "deploy.sh" ]; then
    bash deploy.sh
    echo "  ‚úì Deployed"
else
    echo "  ‚ö†Ô∏è  No deploy script found"
fi

echo ""
echo "‚úÖ Pipeline completed successfully!"
'''


# =============================================================================
# TEMPLATE REGISTRY
# =============================================================================

TEMPLATES = {
    'deployment': {
        'description': 'Full deployment bash script with tests, build, and deploy steps',
        'generator': generate_deployment_script,
        'parameters': ['app_name', 'build_command', 'test_command', 'deploy_target'],
        'examples': [
            "generate_deployment_script(app_name='my-app', build_command='npm run build')",
            "generate_deployment_script(app_name='api-server', deploy_target='dist/')"
        ],
        'tags': ['deploy', 'automation', 'ci-cd']
    },

    'for-loop': {
        'description': 'For loop iteration over files/items with optional parallel execution',
        'generator': generate_for_loop_script,
        'parameters': ['loop_items', 'loop_command', 'parallel'],
        'examples': [
            "generate_for_loop_script(loop_items='*.jpg', loop_command='convert $file $file.png')",
            "generate_for_loop_script(loop_items='logs/*.log', parallel=True)"
        ],
        'tags': ['loop', 'iteration', 'parallel']
    },

    'package': {
        'description': 'Packaging/bundling script to create distribution tarball',
        'generator': generate_packaging_script,
        'parameters': ['package_name', 'version', 'files_to_include', 'output_dir'],
        'examples': [
            "generate_packaging_script(package_name='myapp', version='2.0.0')",
            "generate_packaging_script(files_to_include='src/ README.md LICENSE')"
        ],
        'tags': ['package', 'bundle', 'distribution']
    },

    'test-runner': {
        'description': 'Test runner with parallel execution and verbose output',
        'generator': generate_test_runner,
        'parameters': ['test_pattern', 'parallel', 'verbose'],
        'examples': [
            "generate_test_runner(parallel=True, verbose=True)",
            "generate_test_runner(test_pattern='*_test.py', parallel=False)"
        ],
        'tags': ['test', 'pytest', 'parallel']
    },

    'error-handling': {
        'description': 'Script with comprehensive error handling and logging',
        'generator': generate_error_handling_script,
        'parameters': ['main_command', 'log_file'],
        'examples': [
            "generate_error_handling_script(main_command='python train.py')",
            "generate_error_handling_script(log_file='deploy.log')"
        ],
        'tags': ['error', 'logging', 'robust']
    },

    'ci-pipeline': {
        'description': 'Full CI/CD pipeline with setup, lint, test, build, deploy stages',
        'generator': generate_ci_pipeline,
        'parameters': ['app_name', 'python_version'],
        'examples': [
            "generate_ci_pipeline(app_name='api-server', python_version='3.9')",
            "generate_ci_pipeline(app_name='web-app')"
        ],
        'tags': ['ci-cd', 'pipeline', 'automation']
    }
}


# =============================================================================
# CLI TESTING
# =============================================================================

if __name__ == '__main__':
    print("üêö Bash Script Template Generator\n")

    print("=" * 70)
    print("1. DEPLOYMENT SCRIPT")
    print("=" * 70)
    print(generate_deployment_script(app_name='soulfra'))

    print("\n" + "=" * 70)
    print("2. FOR LOOP (Parallel)")
    print("=" * 70)
    print(generate_for_loop_script(
        loop_items='*.py',
        loop_command='python $file',
        parallel=True
    ))

    print("\n" + "=" * 70)
    print("3. PACKAGING SCRIPT")
    print("=" * 70)
    print(generate_packaging_script(
        package_name='soulfra-simple',
        version='1.0.0',
        files_to_include='*.py templates/ migrations/'
    ))

    print("\n‚úÖ Bash template generators working!")
