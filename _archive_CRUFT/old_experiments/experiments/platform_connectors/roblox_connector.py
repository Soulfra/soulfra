#!/usr/bin/env python3
"""
Roblox Connector - Generate Lua ModuleScript from Soul Pack

Transforms Soul Pack into Roblox-compatible Lua code with:
- Character identity and stats
- Avatar color scheme (deterministic from username)
- Chat rules enforcement
- API sync endpoints for real-time updates
"""

import hashlib
from pathlib import Path
from typing import Dict, Any, Tuple


class RobloxConnector:
    """Generate Roblox Lua ModuleScript from Soul Pack"""

    def __init__(self):
        self.output_dir = Path('platform_outputs/roblox')
        self.output_dir.mkdir(parents=True, exist_ok=True)

    def _hash_to_color(self, username: str) -> Tuple[int, int, int]:
        """Generate deterministic RGB color from username hash"""
        hash_bytes = hashlib.sha256(username.encode()).digest()
        r = hash_bytes[0]
        g = hash_bytes[1]
        b = hash_bytes[2]
        return (r, g, b)

    def generate(self, soul_pack: Dict[str, Any]) -> str:
        """
        Generate Lua ModuleScript from Soul Pack

        Args:
            soul_pack: Dictionary containing Soul data (from soul_model.py)

        Returns:
            String containing Lua code for Roblox ModuleScript
        """
        identity = soul_pack.get('identity', {})
        essence = soul_pack.get('essence', {})
        expression = soul_pack.get('expression', {})
        connections = soul_pack.get('connections', {})

        username = identity.get('username', 'Unknown')
        user_id = identity.get('user_id', 0)

        # Generate color from username
        r, g, b = self._hash_to_color(username)

        # Calculate level/XP from activity
        post_count = expression.get('post_count', 0)
        level = 1 + (post_count // 10)
        xp = (post_count % 10) * 100

        # Extract values for behavior
        values = essence.get('values', [])
        interests = essence.get('interests', [])

        lua_code = f'''-- Soul ModuleScript for {username}
-- Auto-generated by Soulfra Platform Connector
-- DO NOT EDIT MANUALLY - Sync via /api/soul/sync

local Soul = {{}}

-- IDENTITY (Immutable)
Soul.Identity = {{
    UserID = {user_id},
    Username = "{username}",
    CreatedAt = "{identity.get('created_at', 'Unknown')}"
}}

-- ESSENCE (Evolves Slowly)
Soul.Essence = {{
    Values = {{{', '.join([f'"{v}"' for v in values[:5]])}}},
    Interests = {{{', '.join([f'"{i}"' for i in interests[:5]])}}},
    Expertise = {{{', '.join([f'"{e}"' for e in list(essence.get('expertise', {}).keys())[:3]])}}}
}}

-- EXPRESSION (Changes Frequently)
Soul.Expression = {{
    Level = {level},
    Experience = {xp},
    PostCount = {post_count},
    Karma = {expression.get('karma', 100)},
    LastActive = "{expression.get('last_active', 'Never')}"
}}

-- APPEARANCE (Deterministic from Username)
Soul.Appearance = {{
    ColorScheme = {{
        Primary = Color3.fromRGB({r}, {g}, {b}),
        Secondary = Color3.fromRGB({(r + 50) % 256}, {(g + 50) % 256}, {(b + 50) % 256})
    }},
    AvatarURL = "http://localhost:5000/static/avatars/generated/{username}.png"
}}

-- CHAT RULES (Terms of Service Enforcement)
Soul.ChatRules = {{
    Enabled = true,
    BlockedWords = {{"password", "credit card", "ssn", "hack", "exploit"}},
    RateLimitSeconds = 2,
    MaxMessageLength = 500
}}

-- API SYNC
Soul.Sync = {{
    Endpoint = "http://localhost:5000/api/soul/sync",
    Interval = 60, -- seconds
    LastSync = 0
}}

-- METHODS
function Soul:GetDisplayName()
    return self.Identity.Username
end

function Soul:GetLevel()
    return self.Expression.Level
end

function Soul:CheckChatMessage(message)
    if not self.ChatRules.Enabled then
        return true, ""
    end

    -- Check length
    if #message > self.ChatRules.MaxMessageLength then
        return false, "Message too long"
    end

    -- Check blocked words
    local lowerMessage = string.lower(message)
    for _, word in ipairs(self.ChatRules.BlockedWords) do
        if string.find(lowerMessage, string.lower(word)) then
            return false, "Message contains blocked content"
        end
    end

    return true, ""
end

function Soul:SyncWithServer()
    -- TODO: Implement HTTP request to sync endpoint
    self.Sync.LastSync = tick()
    print("Synced Soul for " .. self.Identity.Username)
end

return Soul
'''
        return lua_code

    def save_to_file(self, lua_code: str, filename: str = None) -> Path:
        """
        Save generated Lua code to file

        Args:
            lua_code: Generated Lua ModuleScript code
            filename: Optional custom filename (defaults to soul_module.lua)

        Returns:
            Path to saved file
        """
        if filename is None:
            filename = 'soul_module.lua'

        filepath = self.output_dir / filename

        with open(filepath, 'w') as f:
            f.write(lua_code)

        return filepath

    def generate_and_save(self, soul_pack: Dict[str, Any], filename: str = None) -> Path:
        """
        Generate Lua code and save to file in one step

        Args:
            soul_pack: Dictionary containing Soul data
            filename: Optional custom filename

        Returns:
            Path to saved file
        """
        lua_code = self.generate(soul_pack)
        return self.save_to_file(lua_code, filename)


if __name__ == '__main__':
    # Test with example Soul Pack
    test_soul = {
        'identity': {
            'user_id': 1,
            'username': 'testplayer',
            'created_at': '2024-12-25T00:00:00Z'
        },
        'essence': {
            'values': ['creativity', 'innovation', 'collaboration'],
            'interests': ['coding', 'gaming', 'art'],
            'expertise': ['python', 'lua', 'web']
        },
        'expression': {
            'post_count': 42,
            'karma': 150,
            'last_active': '2024-12-25T10:00:00Z'
        },
        'connections': {}
    }

    connector = RobloxConnector()
    filepath = connector.generate_and_save(test_soul, 'testplayer_soul.lua')
    print(f"âœ… Generated Roblox Soul Module: {filepath}")
