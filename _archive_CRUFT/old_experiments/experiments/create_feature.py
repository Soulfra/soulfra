#!/usr/bin/env python3
"""
Feature Scaffolding System - Generate Complete Flask Features

Like create-react-app, but for Flask features. Generates everything you need:
- Python module with business logic
- HTML templates
- Database migrations
- Routes
- Tests
- Documentation

Usage:
    # Basic feature
    python3 create_feature.py voting-system

    # Specify type and database tables
    python3 create_feature.py quiz-game --type game --tables quizzes,questions,responses

    # API feature
    python3 create_feature.py notifications --type api --tables notifications

    # Interactive mode
    python3 create_feature.py --interactive
"""

import sys
import os
import re
from pathlib import Path
from typing import Dict, List, Tuple
from datetime import datetime


# ==============================================================================
# NAMING UTILITIES - Uniform Naming Conventions
# ==============================================================================

def to_snake_case(name: str) -> str:
    """Convert any name to snake_case"""
    # Replace hyphens with underscores
    name = name.replace('-', '_')
    # Insert underscores before capitals
    name = re.sub('(.)([A-Z][a-z]+)', r'\1_\2', name)
    name = re.sub('([a-z0-9])([A-Z])', r'\1_\2', name)
    return name.lower()


def to_camel_case(name: str) -> str:
    """Convert any name to CamelCase"""
    parts = re.split('[_-]', name)
    return ''.join(word.capitalize() for word in parts)


def to_kebab_case(name: str) -> str:
    """Convert any name to kebab-case"""
    return to_snake_case(name).replace('_', '-')


def to_title_words(name: str) -> str:
    """Convert to Title Case Words"""
    parts = re.split('[_-]', name)
    return ' '.join(word.capitalize() for word in parts)


# ==============================================================================
# FEATURE NAME CONTAINER - Holds All Naming Variants
# ==============================================================================

class FeatureName:
    """Container for all naming variants of a feature"""

    def __init__(self, name: str):
        self.original = name
        self.snake = to_snake_case(name)
        self.camel = to_camel_case(name)
        self.kebab = to_kebab_case(name)
        self.title = to_title_words(name)

    def __repr__(self):
        return f"""FeatureName(
    snake_case: {self.snake}
    CamelCase:  {self.camel}
    kebab-case: {self.kebab}
    Title Case: {self.title}
)"""


# ==============================================================================
# FEATURE SCAFFOLDER - Main Generator
# ==============================================================================

class FeatureScaffolder:
    """Generates complete feature packages"""

    def __init__(self, feature_name: str, feature_type: str = 'basic', tables: List[str] = None):
        self.name = FeatureName(feature_name)
        self.feature_type = feature_type
        self.tables = tables or []
        self.created_files = []

    def scaffold(self) -> Dict:
        """Generate all feature files"""
        print(f"\nðŸš€ Scaffolding Feature: {self.name.title}")
        print(f"   Type: {self.feature_type}")
        print(f"   Tables: {', '.join(self.tables) if self.tables else 'None'}")
        print()

        results = {
            'python_module': self._create_python_module(),
            'templates': self._create_templates(),
            'migration': self._create_migration(),
            'routes': self._create_routes_snippet(),
            'tests': self._create_tests(),
            'readme': self._create_readme(),
        }

        return results

    def _create_python_module(self) -> str:
        """Generate Python module with business logic"""
        filepath = Path(f"{self.name.snake}.py")

        content = f'''#!/usr/bin/env python3
"""
{self.name.title} - {self.feature_type.title()} Feature

Auto-generated by create_feature.py on {datetime.now().strftime('%Y-%m-%d')}

TODO: Add description of what this feature does
"""

from typing import Dict, Any, List, Optional
from datetime import datetime
from database import get_db


# ==============================================================================
# DATA MODELS & BUSINESS LOGIC
# ==============================================================================

def get_{self.name.snake}_data(limit: int = 100) -> List[Dict]:
    """
    Get {self.name.snake} data from database

    Args:
        limit: Maximum number of records to return

    Returns:
        List of {self.name.snake} records
    """
    conn = get_db()
    results = conn.execute(
        'SELECT * FROM {self.tables[0] if self.tables else self.name.snake} ORDER BY id DESC LIMIT ?',
        (limit,)
    ).fetchall()
    conn.close()

    return [dict(r) for r in results]


def create_{self.name.snake}(data: Dict) -> int:
    """
    Create new {self.name.snake} record

    Args:
        data: Dictionary containing {self.name.snake} data

    Returns:
        ID of created record
    """
    conn = get_db()
    cursor = conn.execute(
        'INSERT INTO {self.tables[0] if self.tables else self.name.snake} (created_at) VALUES (CURRENT_TIMESTAMP)'
    )
    record_id = cursor.lastrowid
    conn.commit()
    conn.close()

    return record_id


def get_{self.name.snake}_by_id(record_id: int) -> Optional[Dict]:
    """
    Get specific {self.name.snake} by ID

    Args:
        record_id: ID of {self.name.snake}

    Returns:
        {self.name.camel} data or None
    """
    conn = get_db()
    result = conn.execute(
        'SELECT * FROM {self.tables[0] if self.tables else self.name.snake} WHERE id = ?',
        (record_id,)
    ).fetchone()
    conn.close()

    return dict(result) if result else None


def update_{self.name.snake}(record_id: int, data: Dict) -> bool:
    """
    Update {self.name.snake} record

    Args:
        record_id: ID of {self.name.snake}
        data: Updated data

    Returns:
        True if successful
    """
    conn = get_db()
    conn.execute(
        'UPDATE {self.tables[0] if self.tables else self.name.snake} SET updated_at = CURRENT_TIMESTAMP WHERE id = ?',
        (record_id,)
    )
    conn.commit()
    conn.close()

    return True


def delete_{self.name.snake}(record_id: int) -> bool:
    """
    Delete {self.name.snake} record

    Args:
        record_id: ID of {self.name.snake}

    Returns:
        True if successful
    """
    conn = get_db()
    conn.execute(
        'DELETE FROM {self.tables[0] if self.tables else self.name.snake} WHERE id = ?',
        (record_id,)
    )
    conn.commit()
    conn.close()

    return True


# ==============================================================================
# FEATURE-SPECIFIC LOGIC
# ==============================================================================

# TODO: Add your custom business logic here

'''

        filepath.write_text(content)
        self.created_files.append(str(filepath))
        return str(filepath)

    def _create_templates(self) -> List[str]:
        """Generate HTML templates"""
        templates_dir = Path('templates') / self.name.snake
        templates_dir.mkdir(parents=True, exist_ok=True)

        created = []

        # Index template
        index_html = templates_dir / 'index.html'
        index_html.write_text(f'''{{%extends "base.html" %}}

{{% block title %}}{self.name.title}{{% endblock %}}

{{% block content %}}
<div class="container" style="max-width: 1200px; margin: 0 auto; padding: 40px 20px;">
    <h1 style="font-size: 36px; margin-bottom: 30px;">{self.name.title}</h1>

    <div class="feature-content">
        <p>Welcome to {self.name.title}!</p>

        <!-- TODO: Add your content here -->

        <div style="margin-top: 30px;">
            <a href="{{{{ url_for('{self.name.snake}_form') }}}}" class="button">Get Started</a>
        </div>
    </div>
</div>
{{% endblock %}}
''')
        created.append(str(index_html))

        # Form template
        form_html = templates_dir / 'form.html'
        form_html.write_text(f'''{{%extends "base.html" %}}

{{% block title %}}{self.name.title} - Form{{% endblock %}}

{{% block content %}}
<div class="container" style="max-width: 800px; margin: 0 auto; padding: 40px 20px;">
    <h1 style="font-size: 32px; margin-bottom: 30px;">{self.name.title} Form</h1>

    <form method="POST" action="{{{{ url_for('{self.name.snake}_submit') }}}}">
        <!-- TODO: Add form fields -->

        <div style="margin-top: 20px;">
            <input type="text" name="example_field" placeholder="Example Field" required style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px;">
        </div>

        <button type="submit" style="margin-top: 20px; padding: 12px 24px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
            Submit
        </button>
    </form>
</div>
{{% endblock %}}
''')
        created.append(str(form_html))

        # Results template
        results_html = templates_dir / 'results.html'
        results_html.write_text(f'''{{%extends "base.html" %}}

{{% block title %}}{self.name.title} - Results{{% endblock %}}

{{% block content %}}
<div class="container" style="max-width: 1200px; margin: 0 auto; padding: 40px 20px;">
    <h1 style="font-size: 32px; margin-bottom: 30px;">{self.name.title} Results</h1>

    <div class="results-grid">
        <!-- TODO: Display results -->

        {{% if items %}}
            {{% for item in items %}}
            <div class="result-card" style="background: #f5f5f5; padding: 20px; border-radius: 8px; margin-bottom: 15px;">
                <h3>Item #{{{{ item.id }}}}</h3>
                <p>{{{{ item.created_at }}}}</p>
            </div>
            {{% endfor %}}
        {{% else %}}
            <p>No results yet.</p>
        {{% endif %}}
    </div>

    <div style="margin-top: 30px;">
        <a href="{{{{ url_for('{self.name.snake}_index') }}}}" class="button">Back to {self.name.title}</a>
    </div>
</div>
{{% endblock %}}
''')
        created.append(str(results_html))

        self.created_files.extend(created)
        return created

    def _create_migration(self) -> str:
        """Generate database migration"""
        migrations_dir = Path('migrations')
        migrations_dir.mkdir(exist_ok=True)

        # Find next migration number
        existing = list(migrations_dir.glob('*.sql'))
        next_num = len(existing) + 1

        migration_file = migrations_dir / f"{next_num:03d}_{self.name.snake}.sql"

        # Generate table schemas
        tables_sql = []
        for table in self.tables:
            tables_sql.append(f'''
CREATE TABLE IF NOT EXISTS {table} (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    -- TODO: Add your columns here
);

CREATE INDEX IF NOT EXISTS idx_{table}_created ON {table}(created_at);
''')

        # Fallback if no tables specified
        if not tables_sql:
            tables_sql.append(f'''
CREATE TABLE IF NOT EXISTS {self.name.snake} (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    -- TODO: Add your columns here
);

CREATE INDEX IF NOT EXISTS idx_{self.name.snake}_created ON {self.name.snake}(created_at);
''')

        content = f'''-- Migration {next_num:03d}: {self.name.title}
-- Generated: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}

{''.join(tables_sql)}
'''

        migration_file.write_text(content)
        self.created_files.append(str(migration_file))
        return str(migration_file)

    def _create_routes_snippet(self) -> str:
        """Generate Flask routes snippet"""
        routes_file = Path(f"_routes_{self.name.snake}.py")

        content = f'''# ==============================================================================
# {self.name.title.upper()} ROUTES
# ==============================================================================
# Generated by create_feature.py
# TODO: Copy these routes into app.py

@app.route('/{self.name.kebab}')
def {self.name.snake}_index():
    """{self.name.title} index page"""
    return render_template('{self.name.snake}/index.html')


@app.route('/{self.name.kebab}/form')
def {self.name.snake}_form():
    """{self.name.title} form page"""
    return render_template('{self.name.snake}/form.html')


@app.route('/{self.name.kebab}/submit', methods=['POST'])
def {self.name.snake}_submit():
    """Handle {self.name.snake} form submission"""
    from {self.name.snake} import create_{self.name.snake}

    # Get form data
    data = {{
        # TODO: Extract form fields
    }}

    # Create record
    record_id = create_{self.name.snake}(data)

    flash('{self.name.title} submitted successfully!', 'success')
    return redirect(url_for('{self.name.snake}_results', id=record_id))


@app.route('/{self.name.kebab}/results')
@app.route('/{self.name.kebab}/results/<int:id>')
def {self.name.snake}_results(id=None):
    """Show {self.name.snake} results"""
    from {self.name.snake} import get_{self.name.snake}_data, get_{self.name.snake}_by_id

    if id:
        item = get_{self.name.snake}_by_id(id)
        if not item:
            flash('{self.name.title} not found', 'error')
            return redirect(url_for('{self.name.snake}_index'))
        items = [item]
    else:
        items = get_{self.name.snake}_data()

    return render_template('{self.name.snake}/results.html', items=items)
'''

        routes_file.write_text(content)
        self.created_files.append(str(routes_file))
        return str(routes_file)

    def _create_tests(self) -> str:
        """Generate test file"""
        test_file = Path(f"test_{self.name.snake}.py")

        content = f'''#!/usr/bin/env python3
"""
Tests for {self.name.title} feature

Run with: pytest test_{self.name.snake}.py
"""

import pytest
from app import app
from database import get_db


def test_{self.name.snake}_index():
    """Test {self.name.snake} index page loads"""
    with app.test_client() as client:
        response = client.get('/{self.name.kebab}')
        assert response.status_code == 200
        assert b'{self.name.title}' in response.data


def test_{self.name.snake}_form():
    """Test {self.name.snake} form page loads"""
    with app.test_client() as client:
        response = client.get('/{self.name.kebab}/form')
        assert response.status_code == 200


def test_{self.name.snake}_submit():
    """Test {self.name.snake} form submission"""
    with app.test_client() as client:
        response = client.post('/{self.name.kebab}/submit', data={{
            'example_field': 'test value'
        }}, follow_redirects=True)
        assert response.status_code == 200


def test_{self.name.snake}_results():
    """Test {self.name.snake} results page loads"""
    with app.test_client() as client:
        response = client.get('/{self.name.kebab}/results')
        assert response.status_code == 200


# ==============================================================================
# BUSINESS LOGIC TESTS
# ==============================================================================

def test_create_{self.name.snake}():
    """Test creating {self.name.snake} record"""
    from {self.name.snake} import create_{self.name.snake}

    data = {{}}
    record_id = create_{self.name.snake}(data)
    assert isinstance(record_id, int)
    assert record_id > 0


def test_get_{self.name.snake}_data():
    """Test getting {self.name.snake} data"""
    from {self.name.snake} import get_{self.name.snake}_data

    results = get_{self.name.snake}_data(limit=10)
    assert isinstance(results, list)
'''

        test_file.write_text(content)
        self.created_files.append(str(test_file))
        return str(test_file)

    def _create_readme(self) -> str:
        """Generate README documentation"""
        readme_file = Path(f"README_{self.name.snake}.md")

        content = f'''# {self.name.title}

Auto-generated feature scaffolding created on {datetime.now().strftime('%Y-%m-%d')}

## Overview

{self.name.title} is a {self.feature_type} feature providing...

TODO: Add description

## Files Created

- `{self.name.snake}.py` - Business logic module
- `templates/{self.name.snake}/` - HTML templates
- `migrations/XXX_{self.name.snake}.sql` - Database schema
- `_routes_{self.name.snake}.py` - Flask routes (copy to app.py)
- `test_{self.name.snake}.py` - Unit and integration tests

## Installation

1. Run database migration:
   ```bash
   sqlite3 soulfra.db < migrations/*_{self.name.snake}.sql
   ```

2. Copy routes from `_routes_{self.name.snake}.py` into `app.py`

3. Test the feature:
   ```bash
   pytest test_{self.name.snake}.py
   ```

4. Visit in browser:
   ```
   http://localhost:5001/{self.name.kebab}
   ```

## API Reference

### Python Functions

- `get_{self.name.snake}_data(limit)` - Get all {self.name.snake} records
- `create_{self.name.snake}(data)` - Create new record
- `get_{self.name.snake}_by_id(id)` - Get specific record
- `update_{self.name.snake}(id, data)` - Update record
- `delete_{self.name.snake}(id)` - Delete record

### Routes

- `GET /{self.name.kebab}` - Index page
- `GET /{self.name.kebab}/form` - Form page
- `POST /{self.name.kebab}/submit` - Submit form
- `GET /{self.name.kebab}/results` - View results

## Database Schema

{f"Tables: {', '.join(self.tables)}" if self.tables else f"Table: {self.name.snake}"}

TODO: Document column names and types

## Testing

Run all tests:
```bash
pytest test_{self.name.snake}.py -v
```

## TODO

- [ ] Customize business logic in `{self.name.snake}.py`
- [ ] Update HTML templates in `templates/{self.name.snake}/`
- [ ] Add database columns in migration file
- [ ] Implement form validation
- [ ] Add error handling
- [ ] Write additional tests
- [ ] Update this README

## Generated by

`create_feature.py` - Feature Scaffolding System
'''

        readme_file.write_text(content)
        self.created_files.append(str(readme_file))
        return str(readme_file)


# ==============================================================================
# CLI INTERFACE
# ==============================================================================

def print_summary(scaffolder: FeatureScaffolder, results: Dict):
    """Print summary of generated files"""
    print("\n" + "=" * 80)
    print(f"  âœ… Feature '{scaffolder.name.title}' scaffolded successfully!")
    print("=" * 80)

    print(f"\nðŸ“¦ Files Created ({len(scaffolder.created_files)} total):\n")

    for file in scaffolder.created_files:
        print(f"   âœ“ {file}")

    print("\nðŸ“‹ Next Steps:\n")
    print(f"   1. Run migration:    sqlite3 soulfra.db < {results['migration']}")
    print(f"   2. Copy routes:      Copy {results['routes']} into app.py")
    print(f"   3. Run tests:        pytest {results['tests']}")
    print(f"   4. Visit browser:    http://localhost:5001/{scaffolder.name.kebab}")

    print("\nðŸ’¡ Tips:\n")
    print(f"   - Edit business logic in {results['python_module']}")
    print(f"   - Customize HTML in templates/{scaffolder.name.snake}/")
    print(f"   - See {results['readme']} for full documentation")

    print("\n" + "=" * 80 + "\n")


def main():
    """CLI entry point"""
    if len(sys.argv) < 2 or sys.argv[1] in ['--help', '-h']:
        print(__doc__)
        return

    feature_name = sys.argv[1]
    feature_type = 'basic'
    tables = []

    # Parse arguments
    if '--type' in sys.argv:
        idx = sys.argv.index('--type')
        feature_type = sys.argv[idx + 1] if idx + 1 < len(sys.argv) else 'basic'

    if '--tables' in sys.argv:
        idx = sys.argv.index('--tables')
        tables_arg = sys.argv[idx + 1] if idx + 1 < len(sys.argv) else ''
        tables = [t.strip() for t in tables_arg.split(',') if t.strip()]

    # Create scaffolder
    scaffolder = FeatureScaffolder(feature_name, feature_type, tables)

    # Generate feature
    results = scaffolder.scaffold()

    # Print summary
    print_summary(scaffolder, results)

    # Optionally run template tests
    if '--test' in sys.argv:
        print("ðŸ§ª Running template tests...")
        os.system('python3 test_all_templates.py')


if __name__ == '__main__':
    main()
