#!/usr/bin/env python3
"""
Route Generator CLI - Scaffold Flask Features Instantly

Uses route_templates.py to generate complete features with routes,
templates, and tests.

Usage:
    # CRUD for a resource
    python3 generate_route.py crud newsletter email,brand,verified

    # API endpoint
    python3 generate_route.py api comments brand_slug

    # Dashboard
    python3 generate_route.py dashboard analytics users,posts,comments

    # Preview only (don't write files)
    python3 generate_route.py crud newsletter email,brand --preview

    # Write to files
    python3 generate_route.py crud newsletter email,brand --write
"""

import sys
import os
from pathlib import Path
from route_templates import RouteTemplate, GeneratedRoute


def print_header(text: str):
    """Print a formatted header"""
    print(f"\n{'=' * 70}")
    print(f"  {text}")
    print(f"{'=' * 70}\n")


def print_section(title: str, content: str, max_lines: int = 20):
    """Print a section with optional truncation"""
    print(f"\n{'â”€' * 70}")
    print(f"ğŸ“„ {title}")
    print(f"{'â”€' * 70}")

    lines = content.split('\n')
    if len(lines) > max_lines:
        print('\n'.join(lines[:max_lines]))
        print(f"\n... ({len(lines) - max_lines} more lines)")
    else:
        print(content)


def write_route_to_file(route: GeneratedRoute, base_path: str = '.'):
    """Write generated route to appropriate files"""
    base_path = Path(base_path)

    results = []

    # 1. Write Flask code to a Python file
    routes_file = base_path / f"routes_{route.name}.py"
    with open(routes_file, 'w') as f:
        f.write(f"# Auto-generated routes for {route.name}\n")
        f.write(f"# Generated by generate_route.py\n\n")
        f.write(route.flask_code)
    results.append(f"âœ… Flask routes: {routes_file}")

    # 2. Write HTML template if it exists
    if route.html_template:
        # Determine template directory
        if '/' in route.url_path:
            template_dir = base_path / 'templates' / route.name
        else:
            template_dir = base_path / 'templates'

        template_dir.mkdir(parents=True, exist_ok=True)
        template_file = template_dir / 'list.html'

        with open(template_file, 'w') as f:
            f.write(route.html_template)
        results.append(f"âœ… HTML template: {template_file}")

    # 3. Write test code
    test_file = base_path / f"test_{route.name}.py"
    with open(test_file, 'w') as f:
        f.write(f"# Auto-generated tests for {route.name}\n")
        f.write(f"# Generated by generate_route.py\n\n")
        f.write(route.test_code)
    results.append(f"âœ… Test file: {test_file}")

    return results


def generate_crud(resource_name: str, fields: list, write: bool = False):
    """Generate CRUD routes"""
    print_header(f"Generating CRUD Routes for '{resource_name}'")

    print(f"ğŸ“‹ Resource: {resource_name}")
    print(f"ğŸ“Š Fields: {', '.join(fields)}")
    print(f"ğŸ”§ Template: CRUD (Create, Read, Update, Delete)")

    # Generate
    route = RouteTemplate.crud(resource_name, fields, require_auth=False)

    # Show preview
    print_section("Flask Routes", route.flask_code, max_lines=30)
    print_section("HTML Template", route.html_template, max_lines=25)
    print_section("Test Code", route.test_code, max_lines=15)

    print(f"\nğŸ“ URL: {route.url_path}")
    print(f"ğŸ“¦ Total: {len(route.flask_code)} chars Flask, {len(route.html_template)} chars HTML, {len(route.test_code)} chars tests")

    # Write if requested
    if write:
        print_header("Writing Files")
        results = write_route_to_file(route)
        for result in results:
            print(result)

        print("\nğŸ’¡ Next steps:")
        print(f"   1. Copy routes from routes_{route.name}.py to app.py")
        print(f"   2. Create database table: {resource_name}")
        print(f"   3. Run tests: pytest test_{route.name}.py")
    else:
        print("\nğŸ’¡ To write these files, add --write flag")

    return route


def generate_api(resource_name: str, path_param: str = None, write: bool = False):
    """Generate API endpoint"""
    print_header(f"Generating API Endpoint for '{resource_name}'")

    print(f"ğŸ“‹ Resource: {resource_name}")
    if path_param:
        print(f"ğŸ”— Path param: {path_param}")
    print(f"ğŸ”§ Template: API Endpoint (GET, POST)")

    # Generate
    route = RouteTemplate.api_endpoint(resource_name, path_param)

    # Show preview
    print_section("Flask API Code", route.flask_code, max_lines=30)
    print_section("Test Code", route.test_code, max_lines=15)

    print(f"\nğŸ“ URL: {route.url_path}")
    print(f"ğŸ“¦ Total: {len(route.flask_code)} chars API code, {len(route.test_code)} chars tests")

    # Write if requested
    if write:
        print_header("Writing Files")
        results = write_route_to_file(route)
        for result in results:
            print(result)

        print("\nğŸ’¡ Next steps:")
        print(f"   1. Copy routes from routes_{route.name}.py to app.py")
        print(f"   2. Implement business logic in the route handlers")
        print(f"   3. Run tests: pytest test_{route.name}.py")
    else:
        print("\nğŸ’¡ To write these files, add --write flag")

    return route


def generate_dashboard(name: str, stats: list, write: bool = False):
    """Generate dashboard page"""
    print_header(f"Generating Dashboard for '{name}'")

    print(f"ğŸ“‹ Dashboard: {name}")
    print(f"ğŸ“Š Stats: {', '.join(stats)}")
    print(f"ğŸ”§ Template: Dashboard (Stats Grid)")

    # Generate
    route = RouteTemplate.dashboard(name, stats)

    # Show preview
    print_section("Flask Dashboard Code", route.flask_code, max_lines=20)
    print_section("HTML Template", route.html_template, max_lines=25)
    print_section("Test Code", route.test_code, max_lines=10)

    print(f"\nğŸ“ URL: {route.url_path}")
    print(f"ğŸ“¦ Total: {len(route.flask_code)} chars Flask, {len(route.html_template)} chars HTML, {len(route.test_code)} chars tests")

    # Write if requested
    if write:
        print_header("Writing Files")
        results = write_route_to_file(route)
        for result in results:
            print(result)

        print("\nğŸ’¡ Next steps:")
        print(f"   1. Copy routes from routes_{route.name}.py to app.py")
        print(f"   2. Ensure database tables exist for stats queries")
        print(f"   3. Run tests: pytest test_{route.name}.py")
    else:
        print("\nğŸ’¡ To write these files, add --write flag")

    return route


def show_help():
    """Show help message"""
    help_text = """
ğŸš€ Route Generator CLI - Scaffold Flask Features Instantly

USAGE:
    python3 generate_route.py <template_type> <resource_name> <params> [--write|--preview]

TEMPLATE TYPES:

  1. CRUD - Complete Create/Read/Update/Delete routes
     Example: python3 generate_route.py crud newsletter email,brand,verified
     Generates: List, Create, View, Edit, Delete routes + HTML templates

  2. API - REST API endpoint (GET, POST)
     Example: python3 generate_route.py api comments brand_slug
     Generates: JSON API endpoint with proper error handling

  3. Dashboard - Stats dashboard page
     Example: python3 generate_route.py dashboard analytics users,posts,comments
     Generates: Dashboard route + HTML template with stats grid

FLAGS:
  --write     Write generated code to files
  --preview   Show preview only (default)

EXAMPLES:

  # Generate CRUD for newsletter (preview only)
  python3 generate_route.py crud newsletter email,brand,verified

  # Generate API endpoint and write to files
  python3 generate_route.py api comments brand_slug --write

  # Generate dashboard (preview)
  python3 generate_route.py dashboard analytics users,posts,comments

  # Quick test - see what gets generated
  python3 generate_route.py crud products name,price,stock --preview

WHAT GETS GENERATED:

  Flask Code:
    - Complete route handlers
    - Form processing
    - Database queries
    - Error handling
    - Flash messages

  HTML Templates:
    - Beautiful responsive design
    - Form inputs
    - Tables/grids
    - Action buttons

  Test Code:
    - Route tests
    - Form submission tests
    - Edge case handling

WORKFLOW:

  1. Generate code:           python3 generate_route.py crud products name,price --preview
  2. Review preview:          Check the output looks good
  3. Write to files:          python3 generate_route.py crud products name,price --write
  4. Copy routes to app.py:   Paste from routes_*.py into your Flask app
  5. Run tests:               pytest test_*.py

Happy generating! ğŸ‰
"""
    print(help_text)


def main():
    """Main CLI entry point"""
    if len(sys.argv) < 2 or sys.argv[1] in ['--help', '-h', 'help']:
        show_help()
        return

    template_type = sys.argv[1].lower()
    write = '--write' in sys.argv

    try:
        if template_type == 'crud':
            if len(sys.argv) < 4:
                print("âŒ Error: CRUD requires resource name and fields")
                print("   Example: python3 generate_route.py crud newsletter email,brand,verified")
                return

            resource_name = sys.argv[2]
            fields = sys.argv[3].split(',')
            generate_crud(resource_name, fields, write=write)

        elif template_type == 'api':
            if len(sys.argv) < 3:
                print("âŒ Error: API requires resource name")
                print("   Example: python3 generate_route.py api comments brand_slug")
                return

            resource_name = sys.argv[2]
            path_param = sys.argv[3] if len(sys.argv) > 3 and not sys.argv[3].startswith('--') else None
            generate_api(resource_name, path_param, write=write)

        elif template_type == 'dashboard':
            if len(sys.argv) < 4:
                print("âŒ Error: Dashboard requires name and stats")
                print("   Example: python3 generate_route.py dashboard analytics users,posts,comments")
                return

            name = sys.argv[2]
            stats = sys.argv[3].split(',')
            generate_dashboard(name, stats, write=write)

        else:
            print(f"âŒ Error: Unknown template type '{template_type}'")
            print("   Valid types: crud, api, dashboard")
            print("   Run with --help for more info")

    except Exception as e:
        print(f"\nâŒ Error: {e}")
        import traceback
        traceback.print_exc()


if __name__ == '__main__':
    main()
